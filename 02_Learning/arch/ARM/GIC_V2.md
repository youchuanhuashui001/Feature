# GIC-V2

- `arm_gic_architecture_specification.pdf`



## 中断类型

- PPI：一个特定于单个处理器的外设中断
- SPI：分配器可以路由到任何指定处理器组合的外设中断
- SGI：由软件写入 GIC 中的 `GICD_SGIR` 寄存器产生的中断。系统使用 `SGI` 进行处理器间通信。软件触发中断相当于中断请求信号的边沿跳变。
  - 当多处理器实现中发生 `SGI` 的时候，中断应答寄存器`GICC_IAR` 中的 `CPUID` 字段标识请求中断的处理器。



## 中断处理模型

- 1-N：只有一个处理器处理中断
- N-N：所有处理器接收中断产生。当一个处理器 `acknowledges` 中断，这个中断的 `pending` 状态仅在当前处理器上被清除掉。其它处理器上对此中断任然保持 `pending` 状态



## 空中断

- GIC 向处理器发出的中断信号有可能不再需要。如果出现这种情况，当处理器确认中断时，GIC 会返回一个特殊的中断 ID，将该中断识别为空中断。
- 空中断产生的原因举例：
  - 在处理器确认中断之前：
    - 软件更改该了中断的优先级
    - 软件禁用了中断
    - 软件更改了中断的目标处理器
    - 对于 1-N 中断，另一个目标处理器先前已确认了该中断





## gic 框架

![image-20231027111724939](image/image-20231027111724939.png)





## 分发器

- `Distributor` 管理所有中断源，确定每个中断的优先级，针对每个 CPU 接口将优先级最高的中断转发到一个或多个 CPU 接口，进行优先级屏蔽和抢占处理。

- `Distributor` 提供了一个编程接口，用于：
  - 全局启用将中断转发到 CPU 接口
  - 启用或禁用每个中断
  - 设置每个中断的优先级
  - 设置每个中断的目标处理器列表
  - 将每个外设中断设置为 电平触发或边沿触发
  - 将每个中断设置为 group0 或 group1
  - 将 SGI 转发到一个或多个目标处理器
  - 提供每个中断状态的可见性
  - 软件设置或清除中断挂起状态的机制



### 中断 ID

- 使用 ID 号识别来自源的中断。每个 CPU 接口最多可以看到 1020 个中断。
- GIC 分配中断 ID 号如下：
  - 中断号ID32 ~ID1019 用于 SPI
  - 中断号 ID0 ~ ID15 用于 SGI
  - 中断号 ID16 ~ ID31 用于 PP
- 多处理器系统中：
  - PPI 被转发到特定的 CPU 接口，并且是该接口专用的。在确定 CPU 接口中断的优先级时，分发器不会考虑与其它接口相关的 PPI。
  - 每个连接的处理器通过写入分发器中的 `GICD_SGIR` 来发出 SGI。每次写入都可以生成具有相同 ID 且针对多个处理器的 SGI。

![选区_229](../../../../../home/tanxzh/图片/选区_229.png)

## CPU 接口

- 每个 CPU 接口块为连接到 GIC 的处理器提供接口。每个 CPU 接口都提供一个编程接口，用于：
  - 启用向处理器发送中断请求信号
  - `acknowleging`中断
  - 指示中断处理完成
  - 设置处理器的中断优先级掩码
  - 定义处理器的抢占策略
  - 确定处理器的最高优先级 `pending`中断

- 启用后，CPU 接口为其连接的处理器获取最高优先级的 `pending` 中断，并确定该中断是否具有足够的优先级以向处理器发出中断请求信号，CPU 接口会考虑中断优先级掩码和处理器的抢占设置。CPU 中断开启后只有优先级高于 `中断优先级掩码` 的中断请求才能被送到 CPU。
- 任何时候，连接的处理器都可以从`GICC_HPPIR` 寄存器中读取其最高优先级`active` 中断的优先级。

- 处理器通过读取 CPU 接口中断应答寄存器来应答中断请求。
  - 该读取返回以下之一：最高优先级`pending` 的中断 ID，这是对中断确认的正常响应
  - 特殊情况：返回空中断
- 当处理器在 CPU 接口处确认中断时，分发器将中断的状态从`pending` 改成 `active / active and pending`。此时，CPU 接口可以向处理器发出另一个中断信号，以抢占处理器上`active` 的中断。
- 当处理器上的中断处理程序完成对中断的处理时，它会写入CPU 接口以指示中断完成



![选区_253](image/选区_253.png)



## CP15

- `ARMv7编程手册(DEN0013D_cortex_a_series_PG).pdf`

- GIC 的基地址保存在 `CP15` 协处理器中。修改系统控制寄存器以及设置中断向量表地址都会用到 `CP15` 协处理器。







# 异常发生

- LR

  - 处理异常后，LR 用于存储返回地址，对于不同的异常，LR 中保存的值也不同

  ![img](image/shapes%2F6ad3e2c3c60f0904f37f85814c9fe41224db8ad6%2Fa9a13f26ada4700be4702988a1c0a3fa.png)

- CPSR

  - 发生异常时 ARM 内核会自动执行以下操作：
    - 将 CPSR 复制到 `SPSR_<mode>` 寄存器中，比如发生 IRQ 异常，CPSR 就会保存到 `SPSR_IRQ` 中
    - 将 lr 存到新模式的 lr 寄存器，比如发生 IRQ 异常，lr 就会保存到 `lr_irq`
    - 将 cpsr 模式位修改为与异常类型相关联的模式



























