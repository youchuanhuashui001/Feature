---
tags:
  - Linux_Driver/Kernel_Fundamentals
aliases:
  - 互斥锁
  - mutex
---
# Mutex (互斥锁)

## 1. 核心概念
- ​**​休眠机制​**​：当锁不可用时，线程​**​主动让出CPU​**​，进入休眠状态（`TASK_UNINTERRUPTIBLE`），被移出调度队列。
- ​**​唤醒机制​**​：锁释放后，内核唤醒等待队列中的线程。
- ​**​实现依赖​**​：`futex`（Fast Userspace Mutex）机制，结合用户空间自旋和内核调度。
* **关键特性​：**​

|​**​特性​**​|​**​说明​**​|
|---|---|
|​**​等待开销​**​|有上下文切换开销（微秒级）|
|​**​CPU占用​**​|等待时CPU利用率0%|
|​**​中断安全性​**​|​**​不可用于中断上下文​**​|
|​**​可嵌套性​**​|支持`mutex_lock()`嵌套调用|
|​**​死锁检测​**​|支持`CONFIG_DEBUG_MUTEXES`（检测递归锁、错误释放等）|

## 2. 使用场景
-  **​进程上下文长临界区​**​
	- 临界区操作耗时（如文件I/O、内存分配）。
```c
struct mutex lock;
mutex_init(&lock);

void write_data(...) {
    mutex_lock(&lock);
    kmalloc(..., GFP_KERNEL); // 允许休眠
    file_operations(...); 
    mutex_unlock(&lock);
}
```
- **​锁持有时间不可预测​**​
	- 例：用户空间系统调用处理。
- ​**​高争用场景​**​
	- 当多个线程频繁争用锁时，休眠比自旋更高效。


## 3. 核心 API

## 4. 示例代码 


## 5. 个人理解
- 互斥锁如果已经被占用，再去获取互斥锁就会进入休眠，直到锁被释放，才从休眠重新进入到就绪队列等待被调度
- 可以用在锁被长时间拥有的情况