# Grus 更新 flash

## 1. 编译

1. 使用scpu工程，使用默认配置编译`make grus_gx8002t_dev_1v_defconfig`
2. 使用bootx工具烧写:`sudo bootx -m grus -t s -c download 0 output/spi_nor/gxscpu.bin`
3. 烧写完成后要重启开发板，再敲回车进行串口交互
4. 开启flash spi驱动

![image-20220526144103737](image/image-20220526144103737.png)



## 2. 测试


xip:0x20200000 0x10200000

| DMA  | 数据位宽（bit） | spi模式      | 结果                              |
| ---- | --------------- | ------------ | --------------------------------- |
| 关闭 | 8               | 标准模式     | read溢出 |
| 关闭 | 8               | Dual模式     | 正常                         |
| 关闭 | 8               | Quad模式     | 正常                            |
| 关闭 | 8 | 标准模式 xip | read溢出 |
| 关闭 | 8 | Dual模式 xip | 正常 |
| 关闭 | 8 | Quad模式 xip | 正常 |
| 打开 | 8 | 标准模式 | 正常 |
| 打开 | 8 | Dual模式 | 正常 |
| 打开 | 8 | Quad模式 | 正常 |
| 打开 | 8 | 标准模式 xip | 正常 |
| 打开 | 8 | Dual模式 xip | 正常     |
| 打开 | 8 | Quad模式 xip | 正常 |
| 关闭 | 32               | 标准模式     | read溢出                        |
| 关闭 | 32               | Dual模式     | 正常                         |
| 关闭 | 32               | Quad模式     | 正常                            |
| 关闭 | 32 | 标准模式 xip | 正常 |
| 关闭 | 32 | Dual模式 xip | 正常 |
| 关闭 | 32 | Quad模式 xip | 正常 |
| 打开 | 32 | 标准模式 | 正常 |
| 打开 | 32 | Dual模式 | 正常 |
| 打开 | 32 | Quad模式 | 正常 |
| 打开 | 32 | 标准模式 xip | 正常 |
| 打开 | 32 | Dual模式 xip | 正常 |
| 打开 | 32 | Quad模式 xip | 正常 |






## 3. 问题

1. 使用bootx工具烧写完成后，打开minicom敲回车出现`Flash JEDEC = 0x856013, model = p25q40l.
   ~sta~`
   1. bootx工具中通过-m选择开发板型号后，工具内部已经自带了.boot程序
   2. 由于当前运行的还是.boot程序，按下回车是执行上一个命令，而上一个命令是download下载，此时已经无法下载，所以会出现上述打印
   3. 重启开发板后运行flash中的程序，此时才能正常工作

2. 查看flash中烧写的bin文件
   1. 使用read



## 4. 测试问题：

### 1. xip，8bit，standard：read出现溢出

```c
boot> sf probe
Flash JEDEC = 0x856013, model = p25q40l.
boot> md.b 0x20200000 100
20200000: 07 0c 00 00 02 00 00 00 00 00 00 00 00 00 00 00    ................
20200010: 01 00 00 00 02 00 00 00 00 00 00 00 1f 00 00 00    ................
20200020: 00 00 00 00 00 00 00 00 06 00 00 00 4e 00 00 00    ............N...
boot> md.b 0x10200000 100
10200000: 00 00 0c 07 00 00 00 02 00 00 00 00 00 00 00 00    ................
10200010: 00 00 00 01 00 00 00 02 00 00 00 00 00 00 00 1f    ................
10200020: 00 00 00 00 00 00 00 00 00 00 00 06 00 00 00 4e    ...............N
boot> sf read 0x20027000 0 100
Receive FIFO overflow interrupt.
    
    
    
boot> sf probe
Flash JEDEC = 0x856013, model = p25q40l.
boot> sf read 0x20027000 0 100
Receive FIFO overflow interrupt.
```

## 2. 32bit,standard,no xip,no dma:read出现溢出

```c
boot> sf probe 
Flash JEDEC = 0x856013, model = p25q40l.
boot> sf read 0x20027000 0 10
SF: 16 bytes @ 0x0 Read: OK
boot> sf read 0x20027000 0 100<INTERRUPT>
boot> md.b 0x20027000 10
20027000: 42 49 4e 48 aa 55 aa 55 01 00 00 00 00 00 00 00    BINH.U.U........
boot> sf read 0x20027000 0 100
SF: 256 bytes @ 0x0 Read: OK
boot> md.b 0x20027000 100  
20027000: 42 49 4e 48 aa 55 aa 55 01 00 00 00 00 00 00 00    BINH.U.U........
20027010: 00 20 00 00 00 00 00 10 00 01 00 10 30 01 00 10    . ..........0...
20027020: 30 01 00 10 30 01 00 10 30 01 00 10 30 01 00 10    0...0...0...0...
20027030: 30 01 00 10 30 01 00 10 30 01 00 10 30 01 00 10    0...0...0...0...
20027040: 30 01 00 10 30 01 00 10 30 01 00 10 30 01 00 10    0...0...0...0...
20027050: 30 01 00 10 30 01 00 10 30 01 00 10 30 01 00 10    0...0...0...0...
20027060: 30 01 00 10 30 01 00 10 30 01 00 10 30 01 00 10    0...0...0...0...
20027070: 30 01 00 10 30 01 00 10 30 01 00 10 30 01 00 10    0...0...0...0...
20027080: 30 01 00 10 30 01 00 10 30 01 00 10 30 01 00 10    0...0...0...0...
20027090: 30 01 00 10 30 01 00 10 34 01 00 10 34 01 00 10    0...0...4...4...
200270a0: 34 01 00 10 34 01 00 10 34 01 00 10 34 01 00 10    4...4...4...4...
200270b0: 34 01 00 10 34 01 00 10 34 01 00 10 34 01 00 10    4...4...4...4...
200270c0: 34 01 00 10 34 01 00 10 34 01 00 10 34 01 00 10    4...4...4...4...
200270d0: 34 01 00 10 34 01 00 10 34 01 00 10 34 01 00 10    4...4...4...4...
200270e0: 34 01 00 10 34 01 00 10 34 01 00 10 34 01 00 10    4...4...4...4...
200270f0: 34 01 00 10 34 01 00 10 34 01 00 10 34 01 00 10    4...4...4...4...
boot> sf erase 0 100
SF: 256 bytes @ 0x0 Erased: OK
boot> sf read 0x20027000 0 100
Receive FIFO overflow interrupt.
```





### 2. 32bit,dma,standard:写0x1000写不进去

```c
boot> sf write 0x1000 0 100
SF: 256 bytes @ 0x0 Written: OK
boot> sf read 0x20027000 0 100
SF: 256 bytes @ 0x0 Read: OK
boot> md.b 0x20027000 100
20027000: 0c 03 00 10 0c 03 00 10 ac 03 00 10 ac 03 00 10    ................
20027010: ac 03 00 10 ac 03 00 10 ac 03 00 10 ac 03 00 10    ................
20027020: ac 03 00 10 ac 03 00 10 88 03 00 10 88 03 00 10    ................
20027030: ac 03 00 10 84 03 00 10 84 03 00 10 ac 03 00 10    ................
20027040: 80 03 00 10 80 03 00 10 b0 03 00 10 e4 03 00 10    ................
20027050: e4 03 00 10 e4 03 00 10 e4 03 00 10 da 03 00 10    ................
20027060: e4 03 00 10 cc 03 00 10 b0 03 00 10 e4 03 00 10    ................
20027070: e4 03 00 10 d6 03 00 10 d2 03 00 10 e4 03 00 10    ................
20027080: c4 03 00 10 c0 03 00 10 e4 03 00 10 c8 03 00 10    ................
20027090: e0 03 00 10 14 04 00 10 14 04 00 10 1c 04 00 10    ................
200270a0: 1c 04 00 10 1c 04 00 10 1c 04 00 10 1c 04 00 10    ................
200270b0: 1c 04 00 10 1c 04 00 10 1c 04 00 10 da 04 00 10    ................
200270c0: da 04 00 10 1c 04 00 10 1a 04 00 10 1a 04 00 10    ................
200270d0: 1c 04 00 10 de 04 00 10 de 04 00 10 e2 04 00 10    ................
200270e0: 9a 0c 00 10 9a 0c 00 10 0e 0d 00 10 0e 0d 00 10    ................
200270f0: 0e 0d 00 10 0e 0d 00 10 0e 0d 00 10 0e 0d 00 10    ................
boot> md.b 0x1000 100  
00001000: 04 00 00 00 6c 10 8f 6f ac 10 cd 10 58 65 06 08    ....l..o....Xe..
00001010: 00 34 80 b6 03 26 58 65 fd 0f aa 10 ca 10 eb 10    .4...&Xe........
00001020: 58 65 07 08 80 97 80 b6 03 26 03 27 58 65 fb 0f    Xe.......&.'Xe..
00001030: 00 e0 36 01 fc ff 01 20 64 f0 01 20 00 f0 01 20    ..6.... d.. ... 
00001040: 00 f0 01 20 00 f0 01 20 70 0c 00 00 0d ea 50 00    ... ... p.....P.
00001050: 8c ea 19 00 a1 c5 23 80 6c dc 00 20 6c d8 00 20    ......#.l.. l.. 
00001060: f4 7c 56 10 4e 60 20 b2 60 92 64 43 27 23 a3 c5    .|V.N` .`.dC'#..
00001070: 23 80 60 b2 60 92 50 3b 08 08 00 33 60 b2 6c d8    #.`.`.P;...3`.l.
00001080: 00 20 00 23 6c dc 00 20 63 90 63 ec 80 00 63 b0    . .#l.. c.c...c.
00001090: 60 92 60 dc 30 20 6c d8 00 20 63 e4 ff 20 60 b0    `.`.0 l.. c.. `.
000010a0: 6c d8 00 20 03 c5 e3 55 61 b0 63 90 63 e4 80 30    l.. ...Ua.c.c..0
000010b0: 63 b0 3c 78 04 f0 01 20 14 f0 01 20 d7 14 03 6d    c.<x... ... ...m
000010c0: 08 ea 04 00 00 37 e8 4f 65 94 63 e4 01 20 03 e9    .....7.Oe.c.. ..
000010d0: fd ff 60 94 78 43 08 e5 00 10 cc 6d 28 e9 f5 ff    ..`.xC.....m(...
000010e0: 8a ea 29 00 a0 c7 23 50 67 c4 29 00 4a d8 00 20    ..)...#Pg.).J.. 
000010f0: 49 c4 29 48 c9 e4 03 00 45 35 0b 6f 07 e9 2f 00    I.)H....E5.o../.
```





## 5. 测试bug

### 1. standard，8bit，no xip，no dma：read溢出

```shell
>>>>>sflash_test:addr=0x0, len = 100
>>>>>>>>>erase addr = 0x0, erase len  = 0x64
Receive FIFO overflow interrupt.
```

### 2. standard，8bit， xip，no dma：read溢出

```shell
boot> sf probe
Flash JEDEC = 0x856013, model = p25q40l.
boot> sf read 0x20027000 0 100
Receive FIFO overflow interrupt.
```

### 3. standard，8bit，xip，dma：写入数据错误

0x10000000:ibus
0x20000000:dbus

​		**使用sf write时应该加上i-bus或者d-bus的基址**

```shell
boot> md.b 0x1020 100
m

00001020: 58 65 07 08 80 97 80 b6 03 26 03 27 58 65 fb 0f    Xe.......&.'Xe..
00001030: 00 e0 36 01 fc ff 01 20 64 f0 01 20 00 f0 01 20    ..6.... d.. ... 
00001040: 00 f0 01 20 00 f0 01 20 70 0c 00 00 0d ea 50 00    ... ... p.....P.
00001050: 8c ea 19 00 a1 c5 23 80 6c dc 00 20 6c d8 00 20    ......#.l.. l.. 
00001060: f4 7c 56 10 4e 60 20 b2 60 92 64 43 27 23 a3 c5    .|V.N` .`.dC'#..
00001070: 23 80 60 b2 60 92 50 3b 08 08 00 33 60 b2 6c d8    #.`.`.P;...3`.l.
00001080: 00 20 00 23 6c dc 00 20 63 90 63 ec 80 00 63 b0    . .#l.. c.c...c.
00001090: 60 92 60 dc 30 20 6c d8 00 20 63 e4 ff 20 60 b0    `.`.0 l.. c.. `.
000010a0: 6c d8 00 20 03 c5 e3 55 61 b0 63 90 63 e4 80 30    l.. ...Ua.c.c..0
000010b0: 63 b0 3c 78 04 f0 01 20 14 f0 01 20 d7 14 03 6d    c.<x... ... ...m
000010c0: 08 ea 04 00 00 37 e8 4f 65 94 63 e4 01 20 03 e9    .....7.Oe.c.. ..
000010d0: fd ff 60 94 78 43 08 e5 00 10 cc 6d 28 e9 f5 ff    ..`.xC.....m(...
000010e0: 8a ea 29 00 a0 c7 23 50 67 c4 29 00 4a d8 00 20    ..)...#Pg.).J.. 
000010f0: 49 c4 29 48 c9 e4 03 00 45 35 0b 6f 07 e9 2f 00    I.)H....E5.o../.
00001100: 23 6c a3 6c 04 31 65 94 63 e4 01 20 03 e9 fd ff    #l.l.1e.c.. ....
00001110: 60 94 48 4a 78 43 00 29 8c 6c 21 e9 f6 ff 00 20    `.HJxC.).l!.... 
boot> sf write 0x1020 0 100


0x10000000:ibus
0x20000000:dbus


SF: 256 bytes @ 0x0 Written: OK
boot> md.b 0x10200000 100
10200000: 70 dc 00 20 04 31 09 dc 02 20 18 30 ff e3 88 f8    p.. .1... .0....
10200010: 44 40 6b 10 8c 6c 03 ea 51 80 23 c7 03 49 ff 31    D@k..l..Q.#..I.1
10200020: 25 b3 42 b3 bb 32 43 dd 03 20 40 b3 41 b3 68 dd    %.B..2C.. @.A.h.
10200030: 04 20 49 dd 02 20 54 07 8c 14 00 20 05 14 c0 08    . I.. T.... ....
10200040: 22 ea 01 a0 a7 3a 65 92 63 e4 0f 30 63 ec 0c 00    "....:e.c..0c...
10200050: 65 b2 3c 78 d0 14 ff e3 df fa 00 e9 03 00 90 14    e.<x............
10200060: 01 30 ff e3 c9 f8 90 14 50 03 00 10 50 03 00 10    .0......P...P...
10200070: f0 03 00 10 f0 03 00 10 f0 03 00 10 f0 03 00 10    ................
10200080: f0 03 00 10 f0 03 00 10 f0 03 00 10 f0 03 00 10    ................
10200090: cc 03 00 10 cc 03 00 10 f0 03 00 10 c8 03 00 10    ................
102000a0: c8 03 00 10 f0 03 00 10 c4 03 00 10 c4 03 00 10    ................
102000b0: f4 03 00 10 28 04 00 10 28 04 00 10 28 04 00 10    ....(...(...(...
102000c0: 28 04 00 10 1e 04 00 10 28 04 00 10 10 04 00 10    (.......(.......
102000d0: f4 03 00 10 28 04 00 10 28 04 00 10 1a 04 00 10    ....(...(.......
102000e0: 16 04 00 10 28 04 00 10 08 04 00 10 04 04 00 10    ....(...........
102000f0: 28 04 00 10 0c 04 00 10 24 04 00 10 58 04 00 10    (.......$...X...
boot> md.b 0x20200000 100
20200000: 70 dc 00 20 04 31 09 dc 02 20 18 30 ff e3 88 f8    p.. .1... .0....
20200010: 44 40 6b 10 8c 6c 03 ea 51 80 23 c7 03 49 ff 31    D@k..l..Q.#..I.1
20200020: 25 b3 42 b3 bb 32 43 dd 03 20 40 b3 41 b3 68 dd    %.B..2C.. @.A.h.
20200030: 04 20 49 dd 02 20 54 07 8c 14 00 20 05 14 c0 08    . I.. T.... ....
20200040: 22 ea 01 a0 a7 3a 65 92 63 e4 0f 30 63 ec 0c 00    "....:e.c..0c...
20200050: 65 b2 3c 78 d0 14 ff e3 df fa 00 e9 03 00 90 14    e.<x............
20200060: 01 30 ff e3 c9 f8 90 14 50 03 00 10 50 03 00 10    .0......P...P...
20200070: f0 03 00 10 f0 03 00 10 f0 03 00 10 f0 03 00 10    ................
20200080: f0 03 00 10 f0 03 00 10 f0 03 00 10 f0 03 00 10    ................
20200090: cc 03 00 10 cc 03 00 10 f0 03 00 10 c8 03 00 10    ................
202000a0: c8 03 00 10 f0 03 00 10 c4 03 00 10 c4 03 00 10    ................
202000b0: f4 03 00 10 28 04 00 10 28 04 00 10 28 04 00 10    ....(...(...(...
202000c0: 28 04 00 10 1e 04 00 10 28 04 00 10 10 04 00 10    (.......(.......
202000d0: f4 03 00 10 28 04 00 10 28 04 00 10 1a 04 00 10    ....(...(.......
202000e0: 16 04 00 10 28 04 00 10 08 04 00 10 04 04 00 10    ....(...........
202000f0: 28 04 00 10 0c 04 00 10 24 04 00 10 58 04 00 10    (.......$...X...
```

### 4. standard，32bit，no xip，no dma：read溢出

```shell
boot> sf read 0x20027000 0 1000
Receive FIFO overflow interrupt.
```

### 5. 关闭  32  标准模式 xip  读取正常后擦除，擦除后再读取出线溢出

```
boot> md.b 0x20200000 100
20200000: 04 00 00 00 6c 10 8f 6f ac 10 cd 10 58 65 06 08    ....l..o....Xe..
20200010: 00 34 80 b6 03 26 58 65 fd 0f aa 10 ca 10 eb 10    .4...&Xe........
20200020: 58 65 07 08 80 97 80 b6 03 26 03 27 58 65 fb 0f    Xe.......&.'Xe..
20200030: 00 e0 36 01 fc ff 01 20 64 f0 01 20 00 f0 01 20    ..6.... d.. ... 
20200040: 00 f0 01 20 00 f0 01 20 70 0c 00 00 0d ea 50 00    ... ... p.....P.
20200050: 8c ea 19 00 a1 c5 23 80 6c dc 00 20 6c d8 00 20    ......#.l.. l.. 
20200060: f4 7c 56 10 4e 60 20 b2 60 92 64 43 27 23 a3 c5    .|V.N` .`.dC'#..
20200070: 23 80 60 b2 60 92 50 3b 08 08 00 33 60 b2 6c d8    #.`.`.P;...3`.l.
20200080: 00 20 00 23 6c dc 00 20 63 90 63 ec 80 00 63 b0    . .#l.. c.c...c.
20200090: 60 92 60 dc 30 20 6c d8 00 20 63 e4 ff 20 60 b0    `.`.0 l.. c.. `.
202000a0: 6c d8 00 20 03 c5 e3 55 61 b0 63 90 63 e4 80 30    l.. ...Ua.c.c..0
202000b0: 63 b0 3c 78 04 f0 01 20 14 f0 01 20 d7 14 03 6d    c.<x... ... ...m
202000c0: 08 ea 04 00 00 37 e8 4f 65 94 63 e4 01 20 03 e9    .....7.Oe.c.. ..
202000d0: fd ff 60 94 78 43 08 e5 00 10 cc 6d 28 e9 f5 ff    ..`.xC.....m(...
202000e0: 8a ea 29 00 a0 c7 23 50 67 c4 29 00 4a d8 00 20    ..)...#Pg.).J.. 
202000f0: 49 c4 29 48 c9 e4 03 00 45 35 0b 6f 07 e9 2f 00    I.)H....E5.o../.
boot> sf erase 0 100
SF: 256 bytes @ 0x0 Erased: OK
boot> sf read 0x20027000 0 100
Receive FIFO overflow interrupt.
```