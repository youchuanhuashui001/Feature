
#doing 


# **ğŸ”§ ä»Šæ—¥å·¥ä½œå®‰æ’**
- cursor çŸ¥è¯†åº“
- SPINand UM æ”¯æŒ
- i2c linux é©±åŠ¨å­¦ä¹ 


# **ğŸ“Œ å·¥ä½œè¿›å±•**



---

# **âš ï¸ é—®é¢˜ä¸è§£å†³**


---

# **ğŸ’¡ æŠ€æœ¯æ€»ç»“**


Read file: base/dd. c
Read file: base/bus. c
Read file: base/dd. c
Read file: base/base. h

å¤ªå¥½äº†ï¼ç°åœ¨æˆ‘æ‰¾åˆ°äº†å…³é”®ä¿¡æ¯ã€‚`driver_match_device` å‡½æ•°å®šä¹‰åœ¨ `base/base.h` ç¬¬ 120è¡Œï¼š

```c
static inline int driver_match_device(struct device_driver *drv,
				      struct device *dev)
{
	return drv->bus->match ? drv->bus->match(dev, drv) : 1;
}
```

è¿™å°±æ˜¯è°ƒç”¨ `bus->match` çš„å…³é”®å‡½æ•°ï¼ç°åœ¨è®©æˆ‘æ€»ç»“æ•´ä¸ªæ¡†æ¶å¹¶åˆ¶ä½œå›¾è¡¨ã€‚

## Linux è®¾å¤‡é©±åŠ¨æ¡†æ¶è¯¦ç»†åˆ†æ

æ ¹æ®å¯¹ä»£ç çš„æ·±å…¥åˆ†æï¼Œç°åœ¨æˆ‘æ¥è¯¦ç»†å›ç­”æ‚¨çš„é—®é¢˜ï¼š

### 1. platform_bus_type çš„ match å’Œ probe è°ƒç”¨æµç¨‹

#### match å›è°ƒå‡½æ•°è°ƒç”¨ä½ç½®ï¼š

**ä»£ç ä½ç½®ï¼š** `drivers/base/base.h:120-123`
```c
static inline int driver_match_device(struct device_driver *drv,
				      struct device *dev)
{
	return drv->bus->match ? drv->bus->match(dev, drv) : 1;
}
```

**è°ƒç”¨è·¯å¾„ï¼š**
1. **è®¾å¤‡æ³¨å†Œæ—¶çš„åŒ¹é…ï¼š**
   - `platform_device_register()` â†’ `device_add()` â†’ `bus_probe_device()` â†’ `device_attach()` â†’ `__device_attach()` â†’ `bus_for_each_drv()` â†’ `__device_attach_driver()` â†’ `driver_match_device()` â†’ `platform_bus_type.match()`

2. **é©±åŠ¨æ³¨å†Œæ—¶çš„åŒ¹é…ï¼š**
   - `platform_driver_register()` â†’ `driver_register()` â†’ `bus_add_driver()` â†’ `driver_attach()` â†’ `bus_for_each_dev()` â†’ `__driver_attach()` â†’ `driver_match_device()` â†’ `platform_bus_type.match()`

#### probe å›è°ƒå‡½æ•°è°ƒç”¨ä½ç½®ï¼š

**ä»£ç ä½ç½®ï¼š** `drivers/base/platform.c:555-580`
```c
static int platform_drv_probe(struct device *_dev)
{
	struct platform_driver *drv = to_platform_driver(_dev->driver);
	struct platform_device *dev = to_platform_device(_dev);
	int ret;

	/* ... ç”µæºç®¡ç†ä»£ç  ... */
	
	ret = drv->probe(dev);  // è¿™é‡Œè°ƒç”¨å…·ä½“é©±åŠ¨çš„probe
	
	/* ... é”™è¯¯å¤„ç† ... */
	return ret;
}
```

**è°ƒç”¨è·¯å¾„ï¼š**
- `driver_match_device()` åŒ¹é…æˆåŠŸå â†’ `driver_probe_device()` â†’ `really_probe()` â†’ `dev->bus->probe()` â†’ `platform_drv_probe()` â†’ `drv->probe()`

### 2. i2c_bus_type çš„ match å’Œ probe è°ƒç”¨æµç¨‹

#### match å›è°ƒå‡½æ•°è°ƒç”¨ä½ç½®ï¼š

**ä»£ç ä½ç½®ï¼š** `drivers/i2c/i2c-core.c:690-710`
```c
static int i2c_device_match(struct device *dev, struct device_driver *drv)
{
	struct i2c_client	*client = i2c_verify_client(dev);
	struct i2c_driver	*driver;

	/* è®¾å¤‡æ ‘åŒ¹é… */
	if (of_driver_match_device(dev, drv))
		return 1;

	/* ACPIåŒ¹é… */
	if (acpi_driver_match_device(dev, drv))
		return 1;

	driver = to_i2c_driver(drv);
	/* IDè¡¨åŒ¹é… */
	if (driver->id_table)
		return i2c_match_id(driver->id_table, client) != NULL;

	return 0;
}
```

**è°ƒç”¨è·¯å¾„ï¼š** ä¸ platform ç›¸åŒï¼Œé€šè¿‡ `driver_match_device()` è°ƒç”¨

#### probe å›è°ƒå‡½æ•°è°ƒç”¨ä½ç½®ï¼š

**ä»£ç ä½ç½®ï¼š** `drivers/i2c/i2c-core.c:896-970`
```c
static int i2c_device_probe(struct device *dev)
{
	struct i2c_client	*client = i2c_verify_client(dev);
	struct i2c_driver	*driver;
	int status;

	/* ... å‚æ•°æ£€æŸ¥ ... */
	
	status = driver->probe(client, i2c_match_id(driver->id_table, client));
	
	/* ... é”™è¯¯å¤„ç† ... */
	return status;
}
```

**è°ƒç”¨è·¯å¾„ï¼š** ä¸ platform ç›¸åŒï¼Œé€šè¿‡ `really_probe()` è°ƒç”¨

### 3. æ§åˆ¶å™¨é©±åŠ¨ã€æ§åˆ¶å™¨è®¾å¤‡ã€slave é©±åŠ¨ã€slave è®¾å¤‡çš„å…³ç³»

#### Platform æ€»çº¿æ¡†æ¶ï¼š

```mermaid
classDiagram
    class platform_bus_type {
        +name: "platform"
        +match: platform_match()
        +probe: platform_drv_probe()
        +remove: platform_drv_remove()
    }

    class platform_device {
        +name: string
        +id: int
        +dev: device
        +resource: Resource[] "èµ„æºæ•°ç»„"
        +num_resources: int
    }

    class platform_driver {
        +driver: device_driver
        +probe(): int
        +remove(): int
        +id_table: platform_device_id[]
    }

    class device_driver {
        +name: string
        +bus: bus_type*
        +of_match_table: of_device_id[]
    }

    class device {
        +driver: device_driver*
        +bus: bus_type*
        +parent: device*
    }

    platform_bus_type o-- "*" platform_device : "ç®¡ç†"
    platform_bus_type o-- "*" platform_driver : "ç®¡ç†"
    device_driver <|-- platform_driver : "ç»§æ‰¿"
    device <|-- platform_device : "ç»§æ‰¿"
    platform_driver o-- "*" platform_device : "åŒ¹é…å’Œç»‘å®š"
```



#### I2C æ€»çº¿æ¡†æ¶ï¼š

```mermaid
classDiagram
    class i2c_bus_type {
        +name: "i2c"
        +match: i2c_device_match()
        +probe: i2c_device_probe()
        +remove: i2c_device_remove()
    }

    class i2c_adapter {
        +dev: device
        +algo: i2c_algorithm*
        +nr: int
        +name: string
        +é”æœºåˆ¶: "mutex/rt_mutex"
    }

    class i2c_client {
        +addr: "ä»è®¾å¤‡åœ°å€"
        +name: string
        +adapter: i2c_adapter*
        +dev: device
        +flags: "æ ‡å¿—ä½"
    }

    class i2c_driver {
        +driver: device_driver
        +probe(): int
        +remove(): int
        +id_table: i2c_device_id[]
    }

    class i2c_algorithm {
        +master_xfer() "ä¸»ä¼ è¾“å‡½æ•°"
        +smbus_xfer() "SMBusä¼ è¾“å‡½æ•°"
        +functionality() "åŠŸèƒ½æŸ¥è¯¢"
    }

    class platform_driver_i2c_controller {
        +platform_driver: platform_driver
        +probe(): int "åˆå§‹åŒ–I2Cæ§åˆ¶å™¨"
        +remove(): int "æ¸…ç†èµ„æº"
    }

    i2c_bus_type o-- "*" i2c_client : "ç®¡ç†"
    i2c_bus_type o-- "*" i2c_driver : "ç®¡ç†"
    i2c_adapter o-- "*" i2c_client : "ç®¡ç†ä»è®¾å¤‡"
    i2c_adapter *-- "1" i2c_algorithm : "ä½¿ç”¨ç®—æ³•"
    i2c_driver o-- "*" i2c_client : "åŒ¹é…å’Œç»‘å®š"
    platform_driver_i2c_controller -- i2c_adapter : "åˆ›å»ºå’Œæ³¨å†Œ"
```

#### å®Œæ•´çš„è®¾å¤‡é©±åŠ¨æ³¨å†Œæµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant DT as è®¾å¤‡æ ‘/ACPI
    participant Platform as Platformæ€»çº¿
    participant I2CCtrl as I2Cæ§åˆ¶å™¨é©±åŠ¨
    participant I2CAdapter as I2C Adapter
    participant I2CBus as I2Cæ€»çº¿
    participant I2CDevice as I2Cè®¾å¤‡
    participant I2CDriver as I2Cè®¾å¤‡é©±åŠ¨

    Note over DT,I2CDriver: 1. I2Cæ§åˆ¶å™¨åˆå§‹åŒ–
    DT->>Platform: è§£æè®¾å¤‡æ ‘ä¸­çš„I2Cæ§åˆ¶å™¨èŠ‚ç‚¹
    Platform->>I2CCtrl: platform_matchåŒ¹é…æˆåŠŸ
    Platform->>I2CCtrl: platform_drv_probeè°ƒç”¨
    I2CCtrl->>I2CAdapter: åˆ›å»ºi2c_adapter
    I2CCtrl->>I2CAdapter: è®¾ç½®algorithm
    I2CAdapter->>I2CBus: i2c_add_adapter()æ³¨å†Œåˆ°I2Cæ€»çº¿

    Note over DT,I2CDriver: 2. I2Cä»è®¾å¤‡åˆå§‹åŒ–
    I2CAdapter->>DT: æ‰«æè®¾å¤‡æ ‘ä¸­çš„I2Cä»è®¾å¤‡èŠ‚ç‚¹
    I2CAdapter->>I2CDevice: i2c_new_device()åˆ›å»ºi2c_client
    I2CDevice->>I2CBus: device_add()æ³¨å†Œåˆ°I2Cæ€»çº¿

    Note over DT,I2CDriver: 3. I2Cè®¾å¤‡é©±åŠ¨æ³¨å†Œ
    I2CDriver->>I2CBus: i2c_register_driver()
    I2CBus->>I2CDevice: éå†å·²æ³¨å†Œçš„è®¾å¤‡
    I2CBus->>I2CBus: i2c_device_match()åŒ¹é…
    I2CBus->>I2CDriver: i2c_device_probe()è°ƒç”¨
    I2CDriver->>I2CDevice: driver->probe()ç»‘å®šæˆåŠŸ
```

### 4. Linux è®¾å¤‡é©±åŠ¨æ¡†æ¶æ€»ä½“ç†è§£

#### æ ¸å¿ƒæ¦‚å¿µå…³ç³»å›¾ï¼š

```mermaid
classDiagram
    class bus_type {
        +name: string
        +match() "åŒ¹é…å‡½æ•°"
        +probe() "æ¢æµ‹å‡½æ•°"
        +remove() "ç§»é™¤å‡½æ•°"
        +klist_devices: "è®¾å¤‡é“¾è¡¨"
        +klist_drivers: "é©±åŠ¨é“¾è¡¨"
    }

    class device {
        +bus: bus_type*
        +driver: device_driver*
        +parent: device*
        +name: string
        +type: device_type*
    }

    class device_driver {
        +name: string
        +bus: bus_type*
        +probe() "æ¢æµ‹å‡½æ•°"
        +remove() "ç§»é™¤å‡½æ•°"
        +of_match_table: "è®¾å¤‡æ ‘åŒ¹é…è¡¨[]"
    }

    class device_private {
        +knode_bus: "æ€»çº¿èŠ‚ç‚¹"
        +knode_driver: "é©±åŠ¨èŠ‚ç‚¹"
        +deferred_probe: "å»¶è¿Ÿæ¢æµ‹é“¾è¡¨"
    }

    class driver_private {
        +knode_bus: "æ€»çº¿èŠ‚ç‚¹"
        +klist_devices: "ç»‘å®šè®¾å¤‡é“¾è¡¨"
    }

    bus_type o-- "*" device : "ç®¡ç†"
    bus_type o-- "*" device_driver : "ç®¡ç†"
    device o-- "0..1" device_driver : "ç»‘å®š"
    device *-- "1" device_private : "ç§æœ‰æ•°æ®"
    device_driver *-- "1" driver_private : "ç§æœ‰æ•°æ®"
```

#### å…³é”®è°ƒç”¨è·¯å¾„æ€»ç»“ï¼š

1. **è®¾å¤‡æ³¨å†Œæµç¨‹ï¼š**
   ```
   è®¾å¤‡æ³¨å†Œ â†’ bus_probe_device() â†’ device_attach() â†’ 
   éå†é©±åŠ¨åˆ—è¡¨ â†’ driver_match_device() â†’ bus->match() â†’ 
   åŒ¹é…æˆåŠŸ â†’ driver_probe_device() â†’ bus->probe() â†’ å…·ä½“é©±åŠ¨probe()
   ```

2. **é©±åŠ¨æ³¨å†Œæµç¨‹ï¼š**
   ```
   é©±åŠ¨æ³¨å†Œ â†’ bus_add_driver() â†’ driver_attach() â†’ 
   éå†è®¾å¤‡åˆ—è¡¨ â†’ driver_match_device() â†’ bus->match() â†’ 
   åŒ¹é…æˆåŠŸ â†’ driver_probe_device() â†’ bus->probe() â†’ å…·ä½“é©±åŠ¨probe()
   ```

3. **å»¶è¿Ÿæ¢æµ‹æœºåˆ¶ï¼š**
   - å½“ probe è¿”å› `-EPROBE_DEFER` æ—¶ï¼Œè®¾å¤‡è¢«åŠ å…¥å»¶è¿Ÿæ¢æµ‹é˜Ÿåˆ—
   - æ¯å½“æœ‰æ–°é©±åŠ¨æ³¨å†ŒæˆåŠŸæ—¶ï¼Œè§¦å‘å»¶è¿Ÿæ¢æµ‹é˜Ÿåˆ—é‡æ–°æ¢æµ‹

#### åˆ†å±‚æ¶æ„ï¼š

```mermaid
graph TD
    A[åº”ç”¨å±‚] --> B[ç”¨æˆ·ç©ºé—´è®¾å¤‡æ–‡ä»¶]
    B --> C[è®¾å¤‡é©±åŠ¨å±‚]
    C --> D[å­ç³»ç»Ÿå±‚ I2C/SPI/Platformç­‰]
    D --> E[æ€»çº¿æŠ½è±¡å±‚ bus_type]
    E --> F[è®¾å¤‡æ¨¡å‹æ ¸å¿ƒå±‚ device/driver]
    F --> G[å†…æ ¸å¯¹è±¡å±‚ kobject/kset]
    G --> H[ç¡¬ä»¶æŠ½è±¡å±‚]
    H --> I[ç‰©ç†ç¡¬ä»¶]
```

è¿™ä¸ªæ¡†æ¶çš„è®¾è®¡å“²å­¦æ˜¯ï¼š
- **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šè®¾å¤‡æè¿°ã€é©±åŠ¨é€»è¾‘ã€æ€»çº¿åè®®åˆ†ç¦»
- **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰æ€»çº¿ç±»å‹éƒ½éµå¾ªç›¸åŒçš„ device/driver æ¨¡å‹
- **å»¶è¿Ÿç»‘å®š**ï¼šæ”¯æŒåŠ¨æ€åŠ è½½å’Œå¸è½½
- **å±‚æ¬¡åŒ–ç®¡ç†**ï¼šé€šè¿‡ parent æŒ‡é’ˆå½¢æˆè®¾å¤‡æ ‘ç»“æ„
- **å¼‚æ­¥æ¢æµ‹**ï¼šæ”¯æŒå¹¶è¡Œåˆå§‹åŒ–æé«˜å¯åŠ¨é€Ÿåº¦


---

# **ğŸ“š çŸ¥è¯†å…³è”**


---
# **ğŸ“Œ æ˜æ—¥è®¡åˆ’**


---

# **ğŸ’¬ æ‰©å±•è®°å½•**



