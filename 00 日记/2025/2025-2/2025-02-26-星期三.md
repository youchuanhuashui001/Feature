
#doing 


# **ğŸ”§ ä»Šæ—¥å·¥ä½œå®‰æ’**

- [[Sagitta NRE FPGA IODMA æ¨¡å—éªŒè¯]]ï¼šæ–° bit å®Œæ•´æµ‹è¯•
- [[Uboot æ”¯æŒ SPI Nor Flash é©±åŠ¨]]ï¼šäº†è§£å¯åŠ¨æµç¨‹ä»¥åŠ uboot




# **ğŸ“Œ å·¥ä½œè¿›å±•**

## Sagitta IODMA éªŒè¯ï¼š
- éªŒè¯ 16 çº¿è¾“å‡ºåŠŸèƒ½æ˜¯å¦æ­£å¸¸
	- æ­£å¸¸
- æ’æŸ¥å¹¶è§£å†³ IODMA ä¼ è¾“ 0x300 word æ•°æ®æ—¶ä¸­æ–­æ— æ³•è§¦å‘çš„é—®é¢˜
	- æ­£å¸¸
- æµ‹è¯• 48MHz æ—¶é’Ÿé¢‘ç‡ä¸‹ï¼Œèƒ½å¦é¿å… WS2812 å‡ºç°ä¸²è‰²ç°è±¡
	- ä¸²è‰²æ›´ä¸¥é‡äº†ï¼Œä¹‹å‰æ˜¯ 63ns ä¸€ä¸ªå‘¨æœŸçš„æ—¶å€™ï¼Œ5 ä¸ªå‘¨æœŸé«˜ç”µå¹³ï¼Œ5 ä¸ªå‘¨æœŸä½ç”µå¹³æ—¶é—´æ•ˆæœè¿˜æŒºå¥½çš„
	- ç°åœ¨æ˜¯ 64.9ns ä¸€ä¸ªå‘¨æœŸ
	- å’¨è¯¢ï¼š
```
iodma å¯¹æ¥ ws2812 æµ‹è¯•ï¼Œç”¨ sagitta_fpga_top_bit1_FPGA_2025-02-17.bit 32MHz æ—¶é’Ÿçš„æ—¶å€™æ—¶åºåŸºæœ¬å¾ˆå»åˆï¼Œåœ¨å°‘æ•°æƒ…å†µä¸‹ä¼šå‡ºç°é¢œè‰²æ˜¾ç¤ºé”™è¯¯çš„æƒ…å†µï¼›ç”¨ä»Šå¤©å‡ºçš„ bit 48MHz æ—¶é’Ÿï¼Œå¾ˆå¤šæƒ…å†µä¸‹éƒ½ä¼šå‡ºç°é¢œè‰²æ˜¾ç¤ºé”™è¯¯ï¼Œè¦ä¸è¦è€ƒè™‘å•ç‹¬ç»™ iodma å‡ºä¸€ä¸ªå¯¹åº”é¢‘ç‡çš„ bitï¼Ÿ


2-17ï¼š
	1ï¼šH 500ns L 500ns   
	0ï¼šH 375ns L 620ns  6 10
2-26:
	æ•°æ®æ²¡ä¼ è¾“å®Œï¼Œä¸­æ–­å°±ä¸Šæ¥äº†
		??? åé¢æ²¡æœ‰äº†
		
	å‰é¢å¤šäº†ä¸€äº›ä¹±æ‰çš„æ³¢å½¢
	
	48MHz 20.83ns ä¸€ä¸ªå‘¨æœŸ
	å»¶æ—¶ï¼š2ä¸ªå‘¨æœŸ = 62ns å·¦å³
	1: H 500ns L 500ns
	0: H 380ns L 620ns  6 10

ç„¶åå°±æ˜¯ ws2812 è®¸å¤šå‚å®¶æ‰‹å†Œä¸Šæè¿°çš„æ—¶åºèŒƒå›´éƒ½æœ‰å·®å¼‚ï¼Œæˆ‘ä»¬å­æ¿ä¸Šè´´çš„è¿™æ¬¾å‹å·å¯¹åº”æ‰‹å†Œåœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°ï¼Ÿ
```


## Uboot æ”¯æŒ SPI Nor Flashï¼š
- äº†è§£å¯åŠ¨æµç¨‹ï¼š
- Ubootï¼š
	- å¯ç”¨ splï¼š
		- `rom --> spl --> uboot prpper (å®Œæ•´ uboot) --> linux kernel`
		- ç¼–è¯‘ç”Ÿæˆ `spl/u-boot-spl.bin` ä»¥åŠ `u-boot.binï¼ˆå®Œæ•´ ubootï¼‰`
		- 

---

# **âš ï¸ é—®é¢˜ä¸è§£å†³**
- ä¸´æ—¶ä¿å­˜ ws2812 çš„é©±åŠ¨ä¿®æ”¹ï¼š
```diff
diff --git a/board/nationalchip/sagitta_nre_fpga_1v/clk.c b/board/nationalchip/sagitta_nre_fpga_1v/clk.c
index d67358bb..508862c0 100644
--- a/board/nationalchip/sagitta_nre_fpga_1v/clk.c
+++ b/board/nationalchip/sagitta_nre_fpga_1v/clk.c
@@ -55,4 +55,6 @@ void clk_init(void)
 		pll.enable = 0;
 	gx_clk_sys_set_pll(&pll);
 
+	gx_clk_mod_set_src(GX_CLK_MOD_IODMA, GX_CLK_MOD_SRC_PLL);
+
 }
diff --git a/drivers/drv-sagitta/src/gx_iodma.c b/drivers/drv-sagitta/src/gx_iodma.c
index c28f3753..1e963d26 100644
--- a/drivers/drv-sagitta/src/gx_iodma.c
+++ b/drivers/drv-sagitta/src/gx_iodma.c
@@ -91,6 +91,7 @@ int gx_iodma_config(GX_IODMA_TX_CONFIG *config)
 	tx_config.len      = config->len;
 	tx_config.delay    = calc_delay_cycles(config->delay, iodma_dev.pclk);
 
+	gx_dcache_clean_range((uint32_t *)config->addr, (config->len * 4));
 	return 0;
 }
 
@@ -98,10 +99,6 @@ int gx_iodma_start(void)
 {
 	int ret;
 
-	//gx_dcache_clean_range((uint32_t *)tx_config.addr, tx_config.len * 4);
-	// BUG: ç›®å‰æŒ‰èŒƒå›´åˆ· cache æœ‰ç‚¹é—®é¢˜ï¼Œå…¨åˆ·æ²¡é—®é¢˜
-	gx_dcache_clean();
-
 	ret = gx_hal_iodma_transfer(&iodma_dev, &tx_config);
 	if (ret < 0) {
 		printf("IODMA transfer failed, error code: %d\n", ret);
diff --git a/drivers/drv-sagitta/src/gx_ws2812.c b/drivers/drv-sagitta/src/gx_ws2812.c
index f7323dea..9e7ef562 100644
--- a/drivers/drv-sagitta/src/gx_ws2812.c
+++ b/drivers/drv-sagitta/src/gx_ws2812.c
@@ -9,8 +9,8 @@
 #include <string.h>
 
 #define WS2812_BITS_PER_LED    24
-#define WS2812_BIT_0           0x000002aa
-#define WS2811_BIT_1           0x0000aaaa
+#define WS2812_BIT_0           0x00000555
+#define WS2811_BIT_1           0x00005555
 
 #define WS2812_RESET_BITS      0x00000000
 
diff --git a/drivers/drv-sagitta/test/src/gx_ws2812_test.c b/drivers/drv-sagitta/test/src/gx_ws2812_test.c
index 15f834c8..92fc7e90 100644
--- a/drivers/drv-sagitta/test/src/gx_ws2812_test.c
+++ b/drivers/drv-sagitta/test/src/gx_ws2812_test.c
@@ -32,13 +32,6 @@ static void show_help(void)
 static int ensure_ws2812_initialized(void)
 {
     if (!ws2812_init_flag) {
-        // TODO: æ”¾åˆ° pinmux.c æ¥åš
-        /* Configure pins for 2-bit mode */
-        *(unsigned int *)(0xb0910000 + 0x4 * 0) = 0x4;  // P0_0
-        *(unsigned int *)(0xb0910000 + 0xb4) = 0x4;     // P5_5
-        *(unsigned int *)(0xb0900000 + 0x4 * 0) = 38;   // IODMA[0]
-        *(unsigned int *)(0xb0900000 + 0xb4) = 39;      // IODMA[1]
-
         gx_ws2812_init();
         ws2812_init_flag = 1;
         printf("WS2812 module initialized\n");
diff --git a/drivers/hal/src/iodma/gx_hal_iodma.c b/drivers/hal/src/iodma/gx_hal_iodma.c
index 4b997bc1..3c99b3e9 100644
--- a/drivers/hal/src/iodma/gx_hal_iodma.c
+++ b/drivers/hal/src/iodma/gx_hal_iodma.c
@@ -53,15 +53,15 @@
 #define IODMA_DMALITE_DONE_MASK(n)                (IODMA_DMALITE_INT_XFERDONE0 << (n))
 
 // TODO: æ”¹å› 65535
-#define MAX_SINGLE_TRANSFER_LEN                   (0x100)
-//#define MAX_SINGLE_TRANSFER_LEN                   (65535)
+//#define MAX_SINGLE_TRANSFER_LEN                   (0x100)
+#define MAX_SINGLE_TRANSFER_LEN                   (65535)
 #define MAX_GROUP_NUM                             4
 #define BYTES_PER_WORD                            4
 
 #define IODMA_DMALITE_TIMEOUT_DEFAULT             0x7FFF
 
 // TODO: æ³¨é‡Šæ‰
-#define CONFIG_GX_HAL_IODMA_DEBUG
+//#define CONFIG_GX_HAL_IODMA_DEBUG
 #ifdef CONFIG_GX_HAL_IODMA_DEBUG
 #define  iodma_debug(fmt, arg...) \
 	printf("[IODMA] " fmt, ##arg)

```

## 2-26 bit æ•°æ®æ²¡ä¼ å®Œï¼Œä½†æ˜¯ä¸­æ–­ä¸Šæ¥äº†
![[Pasted image 20250226172738.png]]
![[Pasted image 20250226172753.png]]
![[Pasted image 20250226172810.png]]


## 2-26 bit iodma å¼•è„šå¤ç”¨
```c
*(unsigned int *)(0xb0910000 + 0x4 * 0) = 0x4; // P0_0 å¤ç”¨ä¸º iomatrix

*(unsigned int *)(0xb0910000 + 0x4 * 1) = 0x4; // P0_1 å¤ç”¨ä¸º iomatrix

*(unsigned int *)(0xb0910000 + 0x4 * 3) = 0x4; // P0_3 å¤ç”¨ä¸º iomatrix

*(unsigned int *)(0xb0910000 + 0x4 * 4) = 0x4; // P0_4 å¤ç”¨ä¸º iomatrix

*(unsigned int *)(0xb0910000 + 0x4 * 7) = 0x4; // P0_7 å¤ç”¨ä¸º iomatrix

*(unsigned int *)(0xb0910000 + 0x4 * 8) = 0x4; // P1_0 å¤ç”¨ä¸º iomatrix

*(unsigned int *)(0xb0910000 + 0x4 * 9) = 0x4; // P1_1 å¤ç”¨ä¸º iomatrix

*(unsigned int *)(0xb0910000 + 0x4 * 12) = 0x4; // P1_4 å¤ç”¨ä¸º iomatrix

  

*(unsigned int *)(0xb0900000 + 0x4 * 0) = 38; // P0_0 å¤ç”¨æˆ iodma[0]

*(unsigned int *)(0xb0900000 + 0x4 * 1) = 39; // P0_1 å¤ç”¨æˆ iodma[1]

*(unsigned int *)(0xb0900000 + 0x4 * 3) = 40; // P0_3 å¤ç”¨æˆ iodma[2]

*(unsigned int *)(0xb0900000 + 0x4 * 4) = 41; // P0_4 å¤ç”¨æˆ iodma[3]

*(unsigned int *)(0xb0900000 + 0x4 * 7) = 42; // P0_7 å¤ç”¨ä¸º iodma[4]

*(unsigned int *)(0xb0900000 + 0x4 * 8) = 43; // P1_0 å¤ç”¨ä¸º iodma[5]

*(unsigned int *)(0xb0900000 + 0x4 * 9) = 44; // P1_1 å¤ç”¨ä¸º iodma[6]

*(unsigned int *)(0xb0900000 + 0x4 * 12) = 45; // P1_4 å¤ç”¨ä¸º iodma[7]
```


## 2-26 é©±åŠ¨ ws2812 ä¸æ­£å¸¸ï¼Œå‰é¢æœ‰ä¸€äº›æ‚æ³¢
![[Pasted image 20250226195811.png]]


## ä¸²è‰²çš„é—®é¢˜å¯ä»¥ç”¨è½¯ä»¶æ¥è§£å†³ï¼šåœ¨å‘æœ‰æ•ˆæ•°æ®ä¹‹å‰å…ˆå‘ä¸€äº› Reset å‡ºå»ï¼Œè¿™æ ·ç¡®ä¿å¼€å§‹å‘æ•°æ®æ—¶å‰é¢çš„ç¯å¢ƒéƒ½æ˜¯å¹²å‡€çš„
- å‰é¢ 5 ä¸ª word å‘çš„ä¸€ç›´éƒ½æ˜¯ä¸€æ ·çš„æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ä¸æ˜¯æˆ‘è¦å‘çš„ï¼Œcache ä¸­çš„ï¼Ÿè¿˜æ˜¯å“ªé‡Œçš„ï¼Ÿ
```
è¿ç€5ç»„ï¼š
0x 03 25 c4 fe 
```


---

# **ğŸ’¡ æŠ€æœ¯æ€»ç»“**


---

# **ğŸ“š çŸ¥è¯†å…³è”**


---
# **ğŸ“Œ æ˜æ—¥è®¡åˆ’**


---

# **ğŸ’¬ æ‰©å±•è®°å½•**



