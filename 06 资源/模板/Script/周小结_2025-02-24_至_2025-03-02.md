# 工作周小结 (2025-02-24 至 2025-03-02)

## 本周主要任务

- stage1 提供给 bbt 用的时候会使能 4 倍速加快速度，但是 Vega 不支持 bbt 四倍速，后面 virgo 为了支持 bbt 四倍速会再提供两个参数：是否使能四倍速，使能四倍速的方法
- 之前 pclk 和
- rom 切成使用 0x3b
- flash：4 线模式，指令为 0x6b |         |        | SPI模式     | 位宽   | Flash指令              | | ------- | ------ | --------- | ---- | -------------------- | | goxceed | rom    | TX_AND_RX | 8bit | 0x03 + 3字节地址         | | goxceed | stage1 | TX_AND_RX | 8bit | 0x0b + 3字节地址 + dummy | | robots  | rom    | ro        | 8bit | 双线模式, 0x3b           | | robots  | stage1 | ro        | 8bit | 四线模式, 0x6b           | | robots  | bootx  |           | 开dma | 四线模式,0x6b            |
- 26 号的 bit 前面会发一些乱数据，分析具体原因
- 烧写：4 线模式读写，并且开了 DMA
- **任务 2：**[[Uboot 支持 SPI Nor Flash 驱动]] 搭建环境
- **任务 1**：[[WS2811]] 代码确认，测试目前可用的功能，找芯片确认测试标准
- spi 模式是 TX_AND_RX，8bit 位宽
- Robots：
- stage1：
- rom 中 spi 的频率是 8 分频，一直没用上 sample_delay，是不是可以把频率提高点，然后指令也换成 0x0b? 或者用 0x3b?
- spi：ro 模式，8bit 位宽
- 16 线输出也没看，因为有乱数据，没必要看
- 也是用的 gx spi，CPOL、CPHA 配的都是 0，在第一个上升沿采样
- rom 中 spi 的频率是 8 分频，一直没用上 sample_delay，是不是可以把频率提高点，然后指令也换成 0x0b?
- [[Sagitta NRE FPGA IODMA 模块验证]]：
- stage1 为 bbt 用的时候会使能 4 线模式，但是 Vega 不支持 bbt 四倍速，后面 virgo 为了支持 bbt 四倍速会再提供两个参数：是否使能四倍速，使能四倍速的方法
- Stage1：
- 用的是 gx spi，CPOL、CPHA 配的都是 0，在第一个上升沿采样
- Virgo rom、stage1 flash 驱动整理：
- 确认 GT25Q64A 支持的分支，spi 采样点在哪里，上升沿还是下降沿
- flash：双线模式，0x3b
- spi 模式是 TX_AND_RX(读数据的时候需要写数据)，8bit 位宽
- [[Sagitta NRE FPGA IODMA 模块验证]]：新 bit 完整测试
- [[Uboot 支持 SPI Nor Flash 驱动]]：了解启动流程以及 uboot
-
- [[Sagitta NRE FPGA IODMA 模块验证]]：整理好代码，现在只能用 32MHz 的时钟测试，48MHz 的时钟到时候出了 bit 可以直接切过去测试一把就好了
- [[Sagitta NRE FPGA IODMA 模块验证]]: 前面会有乱数据，芯片在仿真
- flash 指令是 0x03 + 3 字节地址，然后开始读数据
- flash 指令是 0x0b + 3 字节地址 + dummy
- ECOSV1.8.3/1.9.6-4-lts, gxloader + ecos
- rom：
- 软件规避串色：发 GRB 之前先发 Reset，确保 GRB 是干净的
- SDKV2.4.1 /1.9.8-8.1, gxloader + ecos



## 任务进展


## 问题与解决

- ---
- ---
- ## Sagitta IODMA 前面的数据是乱的
- - `sagitta_new` 是最新的代码，对应 2-26 的 bit
- - `sagitta_master` 是稍老的代码，对应 2-17 的 bit
- - 给芯片仿真说是没有开时钟
- - 编译选项选成 Os
- - 去掉 hacking 选项生成 bin
- ---
- - 临时保存 ws2812 的驱动修改： ```diff diff --git a/board/nationalchip/sagitta_nre_fpga_1v/clk.c b/board/nationalchip/sagitta_nre_fpga_1v/clk.c index d67358bb..508862c0 100644
- --- a/board/nationalchip/sagitta_nre_fpga_1v/clk.c +++ b/board/nationalchip/sagitta_nre_fpga_1v/clk.c @@ -55,4 +55,6 @@ void clk_init(void) pll.enable = 0; gx_clk_sys_set_pll(&pll); +	gx_clk_mod_set_src(GX_CLK_MOD_IODMA, GX_CLK_MOD_SRC_PLL); + } diff --git a/drivers/drv-sagitta/src/gx_iodma.c b/drivers/drv-sagitta/src/gx_iodma.c index c28f3753..1e963d26 100644
- --- a/drivers/drv-sagitta/src/gx_iodma.c +++ b/drivers/drv-sagitta/src/gx_iodma.c @@ -91,6 +91,7 @@ int gx_iodma_config(GX_IODMA_TX_CONFIG *config) tx_config.len      = config->len; tx_config.delay    = calc_delay_cycles(config->delay, iodma_dev.pclk); +	gx_dcache_clean_range((uint32_t *)config->addr, (config->len * 4)); return 0; } @@ -98,10 +99,6 @@ int gx_iodma_start(void) { int ret;
- -	//gx_dcache_clean_range((uint32_t *)tx_config.addr, tx_config.len * 4);
- -	// BUG: 目前按范围刷 cache 有点问题，全刷没问题
- -	gx_dcache_clean();
- - ret = gx_hal_iodma_transfer(&iodma_dev, &tx_config); if (ret < 0) { printf("IODMA transfer failed, error code: %d\n", ret); diff --git a/drivers/drv-sagitta/src/gx_ws2812.c b/drivers/drv-sagitta/src/gx_ws2812.c index f7323dea..9e7ef562 100644
- --- a/drivers/drv-sagitta/src/gx_ws2812.c +++ b/drivers/drv-sagitta/src/gx_ws2812.c @@ -9,8 +9,8 @@ #include <string.h> #define WS2812_BITS_PER_LED    24
- -#define WS2812_BIT_0           0x000002aa
- -#define WS2811_BIT_1           0x0000aaaa +#define WS2812_BIT_0           0x00000555 +#define WS2811_BIT_1           0x00005555 #define WS2812_RESET_BITS      0x00000000 diff --git a/drivers/drv-sagitta/test/src/gx_ws2812_test.c b/drivers/drv-sagitta/test/src/gx_ws2812_test.c index 15f834c8..92fc7e90 100644
- --- a/drivers/drv-sagitta/test/src/gx_ws2812_test.c +++ b/drivers/drv-sagitta/test/src/gx_ws2812_test.c @@ -32,13 +32,6 @@ static void show_help(void) static int ensure_ws2812_initialized(void) { if (!ws2812_init_flag) {
- -        // TODO: 放到 pinmux.c 来做
- -        /* Configure pins for 2-bit mode */
- -        *(unsigned int *)(0xb0910000 + 0x4 * 0) = 0x4;  // P0_0
- -        *(unsigned int *)(0xb0910000 + 0xb4) = 0x4;     // P5_5
- -        *(unsigned int *)(0xb0900000 + 0x4 * 0) = 38;   // IODMA[0]
- -        *(unsigned int *)(0xb0900000 + 0xb4) = 39;      // IODMA[1]
- - gx_ws2812_init(); ws2812_init_flag = 1; printf("WS2812 module initialized\n"); diff --git a/drivers/hal/src/iodma/gx_hal_iodma.c b/drivers/hal/src/iodma/gx_hal_iodma.c index 4b997bc1..3c99b3e9 100644
- --- a/drivers/hal/src/iodma/gx_hal_iodma.c +++ b/drivers/hal/src/iodma/gx_hal_iodma.c @@ -53,15 +53,15 @@ #define IODMA_DMALITE_DONE_MASK(n)                (IODMA_DMALITE_INT_XFERDONE0 << (n)) // TODO: 改回 65535
- -#define MAX_SINGLE_TRANSFER_LEN                   (0x100)
- -//#define MAX_SINGLE_TRANSFER_LEN                   (65535) +//#define MAX_SINGLE_TRANSFER_LEN                   (0x100) +#define MAX_SINGLE_TRANSFER_LEN                   (65535) #define MAX_GROUP_NUM                             4 #define BYTES_PER_WORD                            4 #define IODMA_DMALITE_TIMEOUT_DEFAULT             0x7FFF // TODO: 注释掉
- -#define CONFIG_GX_HAL_IODMA_DEBUG +//#define CONFIG_GX_HAL_IODMA_DEBUG #ifdef CONFIG_GX_HAL_IODMA_DEBUG #define  iodma_debug(fmt, arg...) \ printf("[IODMA] " fmt, ##arg) ``` ## 2-26 bit 数据没传完，但是中断上来了 ![[Pasted image 20250226172738.png]] ![[Pasted image 20250226172753.png]] ![[Pasted image 20250226172810.png]] ## 2-26 bit iodma 引脚复用 ```c
- *(unsigned int *)(0xb0910000 + 0x4 * 0) = 0x4; // P0_0 复用为 iomatrix
- *(unsigned int *)(0xb0910000 + 0x4 * 1) = 0x4; // P0_1 复用为 iomatrix
- *(unsigned int *)(0xb0910000 + 0x4 * 3) = 0x4; // P0_3 复用为 iomatrix
- *(unsigned int *)(0xb0910000 + 0x4 * 4) = 0x4; // P0_4 复用为 iomatrix
- *(unsigned int *)(0xb0910000 + 0x4 * 7) = 0x4; // P0_7 复用为 iomatrix
- *(unsigned int *)(0xb0910000 + 0x4 * 8) = 0x4; // P1_0 复用为 iomatrix
- *(unsigned int *)(0xb0910000 + 0x4 * 9) = 0x4; // P1_1 复用为 iomatrix
- *(unsigned int *)(0xb0910000 + 0x4 * 12) = 0x4; // P1_4 复用为 iomatrix
- *(unsigned int *)(0xb0900000 + 0x4 * 0) = 38; // P0_0 复用成 iodma[0]
- *(unsigned int *)(0xb0900000 + 0x4 * 1) = 39; // P0_1 复用成 iodma[1]
- *(unsigned int *)(0xb0900000 + 0x4 * 3) = 40; // P0_3 复用成 iodma[2]
- *(unsigned int *)(0xb0900000 + 0x4 * 4) = 41; // P0_4 复用成 iodma[3]
- *(unsigned int *)(0xb0900000 + 0x4 * 7) = 42; // P0_7 复用为 iodma[4]
- *(unsigned int *)(0xb0900000 + 0x4 * 8) = 43; // P1_0 复用为 iodma[5]
- *(unsigned int *)(0xb0900000 + 0x4 * 9) = 44; // P1_1 复用为 iodma[6]
- *(unsigned int *)(0xb0900000 + 0x4 * 12) = 45; // P1_4 复用为 iodma[7] ``` ## 2-26 驱动 ws2812 不正常，前面有一些杂波 ![[Pasted image 20250226195811.png]] ## 串色的问题可以用软件来解决：在发有效数据之前先发一些 Reset 出去，这样确保开始发数据时前面的环境都是干净的
- - 前面 5 个 word 发的一直都是一样的数据，这个数据不是我要发的，cache 中的？还是哪里的？ ``` 连着5组： 0x 03 25 c4 fe ```
- ---
- ### **问题 1：**`cmd/chiptest/chip-sagitta/` 目录下的一套测试接口和 `driver/drv-sagitta/test/src/` 下的一套测试接口，熟悉这两套接口是干嘛的，iodma 和 ws2812 的测试代码放到哪里
- - iodma 和 ws2812 的测试代码都放到 `drivers/drv-sagitta/test/src` 目录下
- - 这里是用于测试驱动接口的 ```diff diff --git a/cmd/Kconfig b/cmd/Kconfig index 9a850959..c19b63b2 100644
- --- a/cmd/Kconfig +++ b/cmd/Kconfig @@ -89,10 +89,15 @@ config CMD_DRIVER_API_TEST Test PADMUX driver functionality including pin multiplexing, drive strength, pull up/down control, open drain settings, etc. +         - WS2812 test (gx_ws2812_test) +           Test WS2812 LED driver functionality including initialization, +           color control, brightness adjustment, and special effects. + Usage: driver_test <module> [args] Example: driver_test uart help driver_test gpio help driver_test padmux help +                 driver_test ws2812 help config CMD_PADMUX_TEST bool "padmux test" @@ -115,6 +120,13 @@ config CMD_RTC_TEST The rtc test command is used to verify the functionality of the rtc driver, including tick setting and getting, alarm setting, and other features. +config CMD_WS2812_TEST +       bool "ws2812 test" +       help +         This option enables the ws2812 test command. +         The ws2812 test command is used to verify the functionality of the ws2812 driver, +         including LED color control, brightness adjustment, special effects, and other features. + source "cmd/flash/Kconfig"
- --- a/cmd/driver_api_test.c +++ b/cmd/driver_api_test.c @@ -19,6 +19,10 @@ #include "gx_keyscan_test.h" #endif +#if __has_include("gx_ws2812_test.h") +#include "gx_ws2812_test.h" +#endif + // 弱函数实现，用于未实现的测试入口 __attribute__((weak)) int gx_uart_test_entry(int argc, char **argv) { @@ -44,6 +48,12 @@ __attribute__((weak)) int gx_keyscan_test_entry(int argc, char **argv) return -1; } +__attribute__((weak)) int gx_ws2812_test_entry(int argc, char **argv) +{ +    printf("WS2812 test not implemented for this chip\n"); +    return -1; +} + // 命令处理函数 static int do_driver_test(cmd_tbl_t *cmdtp, int flag, int argc, char * const argv[]) { @@ -67,6 +77,10 @@ static int do_driver_test(cmd_tbl_t *cmdtp, int flag, int argc, char * const arg gx_keyscan_test_entry(argc - 1, (char **)&argv[1]); return 0; } +    else if(strcmp(argv[1], "ws2812") == 0) { +        gx_ws2812_test_entry(argc - 1, (char **)&argv[1]); +        return 0; +    } else if(strcmp(argv[1], "help") == 0) { return -1; } @@ -83,5 +97,5 @@ U_BOOT_CMD( do_driver_test, // 命令处理函数 "Driver API test commands", "<module> <command> [args]   - Driver API test functions\n"
- -    "Modules: uart, gpio, padmux, keyscan\n" +    "Modules: uart, gpio, padmux, keyscan, ws2812\n" );
- --- a/drivers/drv-sagitta/Makefile +++ b/drivers/drv-sagitta/Makefile @@ -44,6 +44,7 @@ cobj-y += drivers/drv-sagitta/test/src/gx_padmux_test.o cobj-y += drivers/drv-sagitta/test/src/gx_gpio_test.o cobj-y += drivers/drv-sagitta/test/src/gx_rtc_test.o cobj-y += drivers/drv-sagitta/test/src/gx_keyscan_test.o +cobj-y += drivers/drv-sagitta/test/src/gx_ws2812_test.o +drivers/drv-sagitta/test/include/gx_ws2812_test.h +drivers/drv-sagitta/test/src/gx_ws2812_test.c ``` ### **问题 2：** iodma 传 1 个 word 数据无法触发中断，用 `1-03 bit` 可以，`1-17 bit` 不行，`2-17 bit` 可以 ![[Pasted image 20250225151938.png]] ![[Pasted image 20250225151845.png]] ### 问题 3：2-17 bit iodma 传 0x300 个 word 数据，也就是 3 组 dmalite 传输数据，只能组 0 完成，后面的不会触发中断
- - 1-03 bit 正在测试，测下来没问题
- - 2-17 bit 有问题，传 0x300，只能第 1 组传输完成，后面两组的中断不会上来，一直正在传第二组 ![[Pasted image 20250225180548.png]]
- - 逻辑分析仪看数据也没发完，第一组发完了，但是第二组就没发完
- - 芯片让等新的 bit，最近 iodma 和 dmalite 没有修改过 ### 问题 4：IODMA 之前说按范围刷 cache 的接口有问题，是因为用的是物理地址，实际应该用虚拟地址
- - 之前测试用 `gx_dcache_clean_range` 传入参数为物理地址，刷 cache 有问题，一直用的全刷
- - 更换成传入虚拟地址之后没问题了
- ---

## 技术总结

- - WS2812 Delay 寄存器用法：
- - delay 寄存器表示的是延时时间，单位是时钟频率的一个周期，例如要发 1，第一个周期发了 1，delay 配成 1，那么第二个周期也会发 1；如果 delay 是 2，那么第三个周期也会发 1
- - 也可以理解成波形的持续时间是寄存器值+1
- ---
- ---
- ---
- ---
- [[Common_Note#^83f3c5]]
- ---

## 知识关联

- [[Sagitta NRE FPGA IODMA 模块验证#^1c52a8]]
- ---
- ---
- ---
- ---
- ---

## 下周计划

- ---

