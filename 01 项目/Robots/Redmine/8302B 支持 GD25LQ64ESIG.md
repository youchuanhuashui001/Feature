

## Apus Rom Eco flash 启动流程修改

### 默认启动流程
- 从 `FLASH_START_ADDR` 寄存器中读出一个之作为接下来 flash 的起始地址，并开始读数据
- 当前地址如果发现了  stage1 就继续读 stage1；如果没发现就往后一个 block 读，**如果一直读到最后一个 block 都没有读到对的 stage1 就退出读取**

### ecos 后的启动流程
- 如果读到最后一个 block 了，或者是 16MB 之后的地址还是没有读到对的 stage1，flash 读取次数 +1
- 如果启动时间没有到 500ms，就从 0 地址开始重新读 

### 休眠唤醒的问题
- 问题原因：休眠掉电还没完成下一次休眠就又来了，导致 flash 内部没有复位成功
- 掉电掉到多少就开始复位
	- fm25lq128i3：手册描述是 0.4，实际是 0.2
	- 华邦、gd 的好像是 0.8v
- 掉到 0.2 之后还要保持多久才能上电吗？
	- gd 的要保持  300 us
	- fm25lq128i3 要保持 100us
- 然后事业部现在在加大两次休眠唤醒之间的时间，并且是不支持 fm25lq128i3 这款 flash 了‘
- 那后面的片子？怎么处理呢？
	- 好像说不会读写擦的时候掉电，所以直接开关机就可以 
	- 但是我们现在对于 eco 之后的芯片是测不到他们那个休眠唤醒的环境的吧，




## 需要测试的 Case

### case1：rom 启动会失败的问题，这里要开关机怎么覆盖？
- 开机多少秒，然后关机，关机后多长时间开机？
	- 我认为这里是没关系，可以尽可能的快，因为不知道事业部的板子电路实际是怎样的吗，可能有电容掉电慢，然后上电是很快的，flash 内部没复位好，所以只管缩小关机的时间，看看 flash 可不可以正常启动就可以了吧
	- 掉电时间就尽可能短，50ms、100ms、 10ms 应该继电器做不到吧 
### case2：休眠唤醒的问题 

- 咨询一下 
- 手册描述的掉电复位条件：掉到 0.5v 之后维持 300us 就可以复位
![[Pasted image 20241230142811.png]]
- 搭建休眠唤醒的 case
	- 可以考虑搭建 rtc 唤醒
- 开关机测试，多长时间就重启



### 搭建休眠唤醒的 case
- 测试 case 放在 `apus_pmu.c`
- 目前 rtc只支持以 s 为为单位唤醒，并且 test4 函数中没有设置 rtc 的唤醒时间以及中断回调
	- 设置了 rtc 唤醒时间和中断回调之后可以正常唤醒
	- 深度休眠时 flash 的 vcc 为 0v，唤醒后 flash 的 vcc 为 1.8v
- 要做到的测试 case：
	- 进入休眠模式
	- 50ms 之后 rtc 唤醒
	- 唤醒之后直接跑 stage2 的 gx_flash_init 函数
	- 如果可以成功唤醒，就能拿到 flash 的 id；如果不能成功唤醒，就拿不到 flash 的 id

- 进入休眠模式：
- 从 1.88 掉到 0.5v 花了 260us
- 在休眠之前设一个 10ms 的定时器
- 定时器中断触发之后就重新从 rom 跑了

- 先 flash 初始化，xip 初始化，换成 xip 启动，时钟从晶振时钟换成 pll
	- 用 xip 启动跑了一次就挂了
		- 因为 xip 用的是四倍速模式，而进入休眠模式之后 flash 掉电了，需要重新配成四线模式，唤醒的时候直接就是跑的 stage2，就去用 xip 来读数据了，xip 读到错的数据就进了异常，到了 trap_c
	- 不用 xip 启动，可以一直跑 
	- 现在复位是直接跑 stage2：
		- flash 相关的程序在哪里？在 sram，启动第一次的时候就已经拷过去了 
		- xip 启动的时候也是有一部分代码是放到 sram 的，要由 stage1 来搬运这些代码到 sram，搬完之后，就一直在 sram 了，然后进入休眠，
			- sram 的数据会不会没了？不会，因为从 flash 启动的时候就是直接从 stage2 开始跑的，没有执行从 flash 拷数据到 sram 的过程 

#### 咨询事业部：板子掉电一直都是很慢吗？我们这 1ms，2ms 都可以掉完，并且掉到 0v。那你们板子借来用下？测测看 

#### 测试休眠时间很短，这次休眠刚完成，下次休眠就来了
- 注意 fm25lq128i3 的复位要保持多长时间？故意不满足这个时间呢 

#### 设成 1ms 唤醒，会出现唤醒之后，读不到 flash 的情况，flash 的 vcc 是高电平， clk 一直有 
- 抓一下出错是的掉电上电波形 
	- 唤醒后 1ms 去读 flash：
		![[微信图片_2024-12-31_104553_034.png]]
	- 最后一次唤醒的波形：电平从 1.8v 掉到 0.2v 时间大约：770 us，保持 0.2v 以下的时间大约：330us
		![[微信图片_2024-12-31_105145_532.png]]
		![[微信图片_20241231105309.jpg]]
	- 倒数第二次唤醒的波形：电平从 1.8v 掉到 0.2v 时间大约：790 us，保持 0.2v 以下的时间大约：290us
		![[微信图片_2024-12-31_105536_766.png]]
		![[微信图片_2024-12-31_105653_609.png]]		
- **从抓到的波形时间来看满足 fm25lq128i3 的复位要求，但还是会出现成功唤醒后，无法读到 flash 内容的情况，并且复位 apus(不重新上电 flash) 也无法退出这种模式**

- 首先确认下这个是不是和事业部相同的问题，如果是的话，后面可以用这个 case 来过滤 
	- 问题就是 flash 的问题，但是为什么事业部掉电要掉 20ms 或几十 ms 都没掉完，还在 200mv 的样子
		- 问问看事业部早上的测试情况
		- 让事业部测一下 1ms 休眠唤醒的 case



#### 拿事业部的板子测试
- 黑色板子：使用 1ms 的 rtc 休眠唤醒 case 测试
    - 看波形发现 flash 的 **vcc 脚一直没有掉下去，最低也是 0.64v** ，从1.8v掉到 0.64 v 大约1.24ms，所以时序是一直不满足 flash 要求
    - 测试一两分钟就挂了，挂了之后 flash 的 clk 脚有波形， **按下复位按钮之后程序依然跑不起来，flash 的 clk 脚有波形一直在读 flash，flash 挂了**
- 绿色板子：使用 1ms 的 rtc 休眠唤醒 case 测试
    - 看波形发现 flash 的 **vcc 脚一直没有掉下去，最低也是 0.64v** ，从 1.8v 掉到 0.64v 大约1.24ms，时序一直不满足 flash 要求
    - 测试一两分钟就挂了，挂了之后 flash 的 clk 脚没有波形， **按下复位按钮之后程序又能重新跑了，就是说 flash 没死**


#### 平台测试板跑事业部的测试 case，flash 的 vcc 脚可以掉到 0v，这里同样的程序在事业部的板子上掉不到 0v，需要确认板子的差异
- 让事业部确认硬件差异，电压掉不下去肯定是不行的
	- 是由于 sar adc 采样的基准电压是以 flash  vcc 所在的 v1.8 来做的，在 v1.8 上挂了一个 1uf 的电容 
- 这个测试 case 是不是就可以用来过滤休眠唤醒的条件？
	- 这里有个问题，就是看波形是满足 flash 手册要求的，但是 flash 手册又说是不保证 100% 测试有效  
	- 肯定是要两边的板子现象一样嘛，不然我们这边测了事业部拿过去之后现象不一样，那测的没意义 
	- 休眠唤醒目前是 1ms，以多长时间来作为过滤的条件？
		- 手册上面的明确要求：最低是 400mv，时间 200us，或者几百 us
		- 实际 1ms 的掉电测试，比如测多少次，测多少轮都 ok 是不是就可以 


#### 测试 case

##### 10ms rtc 休眠唤醒，测试 10000 次，硬件环境：1+0.1uf 电容 
- 测试情况：
	- 平台测试板子 + fm25lq128i3：拷机 2 分钟就会死 
		- 掉电掉了 10ms，最低也只掉到 240mv，掉不到 0v
	- 事业部黑色板子 + fm25lq128i3：拷机 1 分钟就会死 
		- 掉电掉了 10ms，最低也只掉到 240mv，掉不到 0v
		![[微信图片_20250102132231.jpg]]
	- 平台测试板子 + gd25lq64e：
		- 16:30 开始拷机 






# 备注：
- 需要重点验证下休眠唤醒 