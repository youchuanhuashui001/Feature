

## 背景知识 

芯片中有 `pmu`  域和 `main`  域，`pmu`  域中放了一个红外模块 `(包括 A+B 两个)` ，`main`  域中也放了一个红外模块 `(包含 A+B 两个)` 。对外的 gpio 需要通过 `某个寄存器`  来选择来自 `pmu`  域还是 `main`  域。一般是工作在 `main`  域，低功耗模式(？可能是吧)下 `main`  域没有电了，但是 `pmu`  域还是有电的，可以通过 `pmu`  域的 `irr`  来做遥控器唤醒之类的。


- 配置寄存器将 `ir`  从 `main`  域切换到  `pmu`  域 `0xf500200、0xf5000204、0xf5000208 `
- 配置引脚复用：`C04` 配置为 `1`
- 只需要测 main 域的 irr 通路 


## 测试过程  


### 从 pmu 域切换到 main 域后不解析红外键值 
- 周龙提供的补丁中已经配置了相关寄存器，应该是配了引脚复用之后就可以直接用了 
	- 目前测试 `IR`  不会响应 
	- 咨询芯片，反馈说 `208`  寄存器需要配成 `0x1` 
	- 修改后可以正常工作 


### 使用 gxtest 测试 Linux 跑不起来 

- 使用 gxtest 编译 linux 时，会打印
![[2024-12-09_13-49.png]]

- `fpga`  没有编网络，在 `kernel` 中去掉网络相关的代码，` kernel `  可以正常跑起来了 
- `gxtest`  跑起来之后也还是不响应红外键值，好像过一会之后自己好了

> [!tips]
> -  `linux` 起来后不会自动进到 `gxtest` 的 `shell`，可以先 `kill` 掉这个进程，然后重新执行
> - 不可以放在后台跑，因为 `shell` 需要实时从控制台获取命令 


### 使用 gxtest 测试 ecos 跑不起来 
- 打印发现 `flash` 初始化失败了，没有找到 `/dev/flash/0/0` 这个设备 

- `gxtest/std/goxceed` 中存在两个 `bsp.cpp` 
	- `basic_bsp.cpp` 中会注册一些基础的
	- `board/virgo/fpga/ecos/dvbs/nor/bsp.cpp` 中会注册详细的
		- 这两个 `.cpp` 会叠加起来，要保证需要注册的都注册上，例如 flash 相关的，irr 相关的

>[!tips]
>- 可以直接 `load gxtest`  编译出来的 `.elf`，省得每次烧 `flash` 
> - 仍然需要 loader 中配置好从 `pmu` 域切换到 `main` 域的寄存器，以及 `ir` 的引脚复用 





## 测试结果 
- gxloader 测试完成
- linux 测试完成
- ecos 测试完成 



## 补充测试

### 测试项 1：`pmu` 域寄存器配置
- `0x208` 配成 `0x1` 后无法解析键值，正常 
- `0x208` 配成 `0x3ffff` 后正常解析键值，正常 

- <font color="#245bdb">测试通过</font> 


### 测试项 2：`lowpower` 功能 
- `gxloader` 一定会跑 `irr_init` ?
	- 不是的，只有在开了 `IRR` 选项之后才会初始化
	- 因此需要在 `linux、ecos` 初始化的时候也配置这个寄存器 

- 低功耗功能是通过配置 `IRR_CNTL` 寄存器的 `bit28` 实现的
	- 开启时：`fifo` 读使能通过硬件自动控制 
	- 关闭时：`fifo` 读使能一直打开 


- <font color="#245bdb">测试通过</font> 


## 补充：低功耗功能在 mpw 阶段没有，补丁先不合并 



