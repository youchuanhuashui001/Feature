# RTC 模块测试计划

## 1. 基本信息

- **Redmine 问题号**: `#408040`
- **芯片型号/项目名称**: `Virgo_NRE` 
- **被测模块**: `RTC`
- **固件/FPGA 镜像版本**:  `#404698 [vu9p_virgo_nre_sub_a7.bit] test3 a7核 vu9p板子`
- **测试日期**: `2025-05-12`
- **相关文档**: [[rtc ip]]

## 2. 测试目标
简要描述本次测试的主要目的和范围。
- 兼容 32 位、64 位驱动、测试代码
- RTC 模块验证

## 3. 测试环境

### 3.1 硬件环境

- **FPGA 型号**: `VU9P-05` 

### 3.2 软件环境
```
commit c8c3f8dcc3b0587775e99383adc177c5804cf808 (HEAD -> virgonre, refs/published/virgonre)
Author: tanxzh <tanxzh@nationalchip.com>
Date:   Wed Apr 16 20:20:38 2025 +0800

    406477: Virgo NRE Flash_SPI 模块验证
            1. 新增 ddr 模式
            2. 测试程序支持 64 位
    
    Change-Id: Iff4f3a0f3de42b5cfced0c780313511093660454

commit bbb3a47e7060674f40d776b6e05979adccd18671
Merge: bdc426ea 8444e4ca
Author: 刘非 <liufei@nationalchip.com>
Date:   Sun Apr 27 15:10:15 2025 +0800

    Merge "406515: gxloader 支持 nos lib 的编译" into develop2

commit 8444e4cabfddb2a9ce696f5f0b539cb29e8e745a
Author: yemb <yemb@nationalchip.com>
Date:   Wed Apr 16 16:13:28 2025 +0800

    406515: gxloader 支持 nos lib 的编译
    
    Change-Id: I2c9a76e8f50a46c8e4c67bfa18de5495d9c9f1e9

commit bdc426ea3806369fb99bc6fa4e4c190a7f1fc2bc
Author: yangmch <yangmch@nationalchip.com>
Date:   Fri Mar 14 16:26:33 2025 +0800

    398922: 添加gxloader 支持 eMMC 和 SD支持
    
    Change-Id: Ie240b97650bfbb1572bcaa7e3f0a3029207fb54a
```


## 4. 测试用例与结果

### 测试用例 1: 产生 1HZ 计数
- **用例 ID**: `TC_RTC_001`
- **优先级**: `高`
- **前置条件**:
    - `FPGA已成功加载镜像`
    - `RTC模块已初始化，并已配置为开始计时`
    - `RTC时钟源稳定 (例如：32.768kHz晶振)`
- **测试命令：**
	- 打开 `.config` 中的 `ENABLE_RTC = y`
    - 输入命令：`rtc init`
    - 输入命令：`rtc read`
    - 输入命令：`rtc read`
- **测试步骤**:
    1. 初始化 rtc，包括启动 rtc
    2. 读取RTC CCVR 寄存器
- **预期结果**:
    - RTC计数器每秒加1
- **实际结果**:
	- 与预期一致
- **状态**: 通过
- **备注**:

---

### 测试用例 2: 分频配置
- **用例 ID**: `TC_RTC_002`
- **优先级**: `中`
- **前置条件**:
    - `FPGA已成功加载镜像`
    - `RTC模块已初始化`
- **测试步骤**:
    1. `读取RTC预分频器相关寄存器的默认值`
    2. `根据IP核文档，配置预分频器为不同的分频值 (例如，产生不同的中断周期或1Hz信号)`
    3. `验证配置是否生效 (例如，通过观察1Hz信号频率变化或中断产生周期变化)`
- **预期结果**:
    - `预分频器寄存器可以被正确读写`
    - `修改预分频值后，RTC的计时行为 (如1Hz输出或周期中断) 符合新的配置`
    - `功能正常`
- **实际结果**:
    - `记录实际观察到的现象和数据`
- **状态**: `通过 / 失败 / 阻塞 / 未执行`
- **备注/观察**:
    - `覆盖范围: Function - 计时功能 [01.keep_time]; Feature - 预分频配置 [02.div] - 分频配置`

---

### 测试用例 3: RTC 时间设置与读取测试
- **用例 ID**: `TC_RTC_003`
- **优先级**: `高`
- **前置条件**:
    - `FPGA已成功加载镜像`
    - `RTC模块已初始化`
- **测试步骤**:
    1. `设置一个特定的时间值 (时、分、秒) 到RTC的时间寄存器`
    2. `立即读回RTC的时间寄存器`
    3. `等待一段时间 (例如：5秒)，再次读取RTC的时间寄存器`
- **预期结果**:
    - `设置的时间值能被正确写入RTC寄存器`
    - `立即读回的时间值与设置值一致`
    - `等待一段时间后，读回的时间值在原设定时间基础上正确递增`
- **实际结果**:
    - `记录实际观察到的现象和数据`
- **状态**: `通过 / 失败 / 阻塞 / 未执行`
- **备注/观察**:
    - `覆盖范围: Function - 时间读写; Feature - 寄存器读写`

---

### 测试用例 5: 开启闹钟功能
- **用例 ID**: `TC_RTC_005`
- **优先级**: `高`
- **前置条件**:
    - `FPGA已成功加载镜像`
    - `RTC模块已初始化，当前时间已设置`
    - `RTC闹钟中断已使能，中断服务程序已注册`
- **测试步骤**:
    1. `设置一个未来的闹钟时间 (例如：当前时间 + 10秒)`
    2. `使能闹钟功能`
    3. `监控RTC中断状态寄存器或中断输出信号`
    4. `当RTC当前时间达到闹钟设定时间时，观察行为`
    5. `(可选) 测试不同的闹钟匹配条件 (例如：仅匹配秒，匹配分秒，匹配时分秒等，根据IP核功能)`
- **预期结果**:
    - `当RTC当前时间与闹钟设定时间匹配时，闹钟中断标志位被置位`
    - `中断服务程序被正确调用`
    - `清除中断后，中断标志位能被正确清除`
    - `功能正常`
- **实际结果**:
    - `记录实际观察到的现象和数据`
    - `[[附上逻辑分析仪中断信号截图 (如果适用)]]`
- **状态**: `通过 / 失败 / 阻塞 / 未执行`
- **备注/观察**:
    - `覆盖范围: Function - 闹钟功能 [02.alarm]; Feature - 中断使能配置 [01.interrupt] - 开启闹钟功能; Feature - 中断处理`

---



## 7. 问题与缺陷记录


### 【已解决】问题 1：预分频配置寄存器错误
- 本该配置 CPSR 寄存器，配成了 CPCVR (预分频寄存器当前计数值)，而由于 CPSR 寄存器的默认值是 32768，所以预分频 1HZ 可以正常产生，但无法产生其它分频
```diff
                // 每 1s rtc 计数器自增一次
-               WRITE_REG((uint32_t)dev->regs + RTC_CPCVR, dev->pclk);
+               //WRITE_REG((uint32_t)dev->regs + RTC_CPSR, dev->pclk);
```


### 【已解决】问题 2：RTC A55 平台下用 V11 JLINK 有时候无法读到寄存器的值
- 将频率降到 1000 也不行，降到 100 后可以了


### 问题 3：RTC NRE A7、A55 不计数
- 初始化配置：
	- 读 0x0c(CCR) 寄存器，并或上 1<<4 写入
	- 将 32768 == 0x8000 写入寄存器 0x20 (RTC_CPSR)
	- 读 0x0c (CCR) 寄存器，并或上 1<<2 写入
- 读操作：
	- 读 0x0 (CCVR ) 寄存器，不会更新


- 用 final 的 bit 测试：ok
![[Pasted image 20250515160001.png]]



## 8. 测试总结与结论

- **测试覆盖率评估 (简述)**: `例如：RTC核心功能 (时间日期读写、闹钟、中断、闰年处理、掉电保护) 已覆盖。预分频、校准等高级功能根据IP核支持情况进行了测试。`
- **模块稳定性评估**: `例如：RTC在长时间运行和常规操作下表现稳定。闹钟和中断功能按预期工作。`
- **遗留问题**: `列出尚未解决的关键问题。`
- **后续步骤/建议**:
    - `例如：针对BUG-RTC-001进行根本原因分析。`
    - `例如：进行更长时间的稳定性测试 (例如：连续运行一周)。`
    - `例如：如果IP核支持，增加更多边界条件测试 (例如：跨世纪的日期设置)。`
- **总体测试结果**: `通过 / 条件通过 / 失败`

## 9. 附件

- `[[链接到Log文件]]`
- `[[链接到配置文件]]`
- `[[链接到逻辑分析仪捕获文件.sal 或 示波器截图]]`
- `[[链接到其他相关截图或数据]]`
```