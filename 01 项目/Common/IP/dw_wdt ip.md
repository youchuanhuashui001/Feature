
# 寄存器
以下是 DesignWare DW_apb_wdt（Watchdog Timer）IP 的所有寄存器，按照你提供的排布方式整理。每个寄存器包含名称、描述、大小、偏移地址、存在条件、位域定义以及相关注意事项。

---

## WDT_CR
- **Name**: WDT Control Register
- **Description**: 控制寄存器
- **Size**: 32 bits
- **Offset**: 0x0
- **Exists**: Always


| 位域   | 名称          | 访问  | 描述                                                                                                                                                                                                                                                                     |
| ---- | ----------- | --- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 31:6 | RSVD_WDT_CR | R   | 保留位，读取为 0                                                                                                                                                                                                                                                              |
| 5    | NO_NAME     | R/W | 可读写位，用于测试目的，默认值为 0。                                                                                                                                                                                                                                                    |
| 4:2  | RPL         | R/W | 重置脉冲长度。<br>设置系统复位信号的持续周期数（pclk cycles）。<br>可选值: 2、4、8、16、32、64、128、256 个 pclk 周期。<br>默认值: WDT_DFLT_RPL。<br>若 WDT_HC_RPL = 1，则只读。<br>0x0 = 2pclk;<br>0x1 = 4pcl;<br>0x2 = 8pclk;<br>0x3 = 16pclk;<br>0x4 = 32pclk;<br>0x5 = 64pclk;<br>0x6 = 128pclk;<br>0x7 = 256pclk; |
| 1    | RMOD        | R/W | 响应模式。<br>0: 仅生成系统复位。<br>1: 首先生成中断，若第二次超时前未清除则生成系统复位。<br>默认值: WDT_DFLT_RMOD。<br>若 WDT_HC_RMOD = 1，则只读。                                                                                                                                                                  |
| 0    | WDT_EN      | R/W | 看门狗使能。<br>0: 禁用。<br>1: 使能。<br>默认值: WDT_ALWAYS_EN。<br>若 WDT_ALWAYS_EN = 1，则只读（始终使能）。                                                                                                                                                                                    |

**注意**:
- 复位值：由配置参数决定。
- 使能后只能通过系统复位禁用（若 WDT_ALWAYS_EN = 0）。

---

## WDT_TORR
- **Name**: WDT Timeout Range Register
- **Description**: 超时范围寄存器
- **Size**: 32 bits
- **Offset**: 0x4
- **Exists**: Always



| 位域   | 名称            | 访问  | 描述                                                                                                                   |
| ---- | ------------- | --- | -------------------------------------------------------------------------------------------------------------------- |
| 31:8 | RSVD_WDT_TORR | R   | 保留位，读取为 0                                                                                                            |
| 7:4  | TOP_INIT      | R/W | 首次重启的超时周期（若 WDT_DUAL_TOP = 1）。<br>可选值: 0-15。<br>默认值: WDT_DFLT_TOP_INIT。<br>若 WDT_HC_TOP = 1 或 WDT_ALWAYS_EN = 1，则只读。 |
| 3:0  | TOP           | R/W | 后续重启的超时周期。<br>下一次重启后生效。<br>可选值: 0-15。<br>默认值: WDT_DFLT_TOP。<br>若 WDT_HC_TOP = 1，则只读。                                 |

**注意**:
- 复位值：由配置参数决定。
- 超时周期计算：
  - 若 WDT_USE_FIX_TOP = 1：超时周期 = 2^(16 + i)（i = TOP 或 TOP_INIT）。
  - 若 WDT_USE_FIX_TOP = 0：超时周期 = WDT_USER_TOP_(i) 或 WDT_USER_TOP_INIT_(i)。

超时时间。
当配置参数 WDT_HC_TOP = 1 时，写入无效，导致此寄存器变为只读。
此字段用于选择看门狗计数器重启后的超时时间。
超时时间的更改仅在下次计数器重新启动后生效。
值的范围受 WDT_CNT_WIDTH 限制。
如果 TOP 被变成为选择一个范围，超过计数器宽度，超时周期会被截断到适合的计数器宽度。
这仅影响非用户指定的值，用户在配置这些值的过程中是受到限制的。
32bit 看门狗计数器可用的值范围是：
```
其中 i = TOP 并且 t = 超时周期
for i = 0 to 15
	if WDT_USE_FIX_TOP == 1
		t = 2^(16+i)
	else
		t = WDT_USER_TOP_(i)
```


### Q: 这里的超时时间单位是什么？

看门狗的计时时间计算涉及多个层次的实现，我将详细分析其计算方法。

#### 计时时间的设置流程

从代码实现来看，看门狗计时时间的设置主要通过以下流程：

1. 用户层调用 `gx_wdt_settimeout(int ms)` 函数，传入毫秒值
2. 该函数将毫秒转换为秒，并设置到 `wdt_dev.timeout` 中
3. 然后调用 `gx_hal_watchdog_init()` 进行初始化
4. 在 HAL 层的初始化函数中，调用 `hal_watchdog_set_top()` 设置实际的超时值

#### 具体计算方法

##### 1. 用户层设置

在 `dw_wdt.c` 中：
```c
void gx_wdt_settimeout(int ms)
{
	wdt_dev.mode = GX_HAL_WDT_MODE_RESET;
	wdt_dev.pclk = WDT_SYS_CLK;
	wdt_dev.timeout = ms/1000;  // 毫秒转换为秒
	gx_hal_watchdog_init(&wdt_dev);
	gx_hal_watchdog_start(&wdt_dev);
    while(1);
}
```

这里将用户传入的毫秒值除以 1000 转换为秒，并设置到 `wdt_dev.timeout` 中。

##### 2. HAL 层计算

在 `gx_hal_dw_watchdog. c` 中，实际的超时时间计算由以下函数完成：

```c
static inline int hal_watchdog_top_in_seconds (GX_HAL_WDT *dev, uint32_t top)
{
	/*
	 * There are 16 possible timeout values in 0.. 15 where the number of
	 * cycles is 2 ^ (16 + i) and the watchdog counts down.
	 */

	return (1 << (16 + top)) / dev->pclk;
}
```

这个函数计算给定 `top` 值（0-15 之间的一个值）对应的实际超时秒数。计算公式为：
- 时钟周期数 = 2^(16 + top)
- 超时秒数 = 时钟周期数 / 时钟频率

##### 3. 超时值选择

在 `hal_watchdog_set_top ()` 函数中，会根据用户设置的超时秒数，选择最接近的硬件支持值：

```c
static int hal_watchdog_set_top (GX_HAL_WDT *dev, uint32_t top_s)
{
	int i, top_val = WDT_MAX_TOP;

	/*
	 * Iterate over the timeout values until we find the closest match. We
	 * always look for >=.
	 */
	for (i = 0; i <= WDT_MAX_TOP; ++i) {
		if (hal_watchdog_top_in_seconds (dev, i) >= top_s) {
			top_val = i;
			break;
		}
	}

	// 设置寄存器...

	return hal_watchdog_top_in_seconds (dev, top_val);
}
```

这个函数会遍历所有可能的 `top` 值（0-15），找到第一个大于等于用户设置超时时间的值，并将其设置到硬件寄存器中。

#### 实际计算示例

假设：
- 系统时钟 `WDT_SYS_CLK` = 24,000,000 Hz (24MHz)
- 用户设置超时时间为 5000 毫秒 (5 秒)

计算过程：
1. `wdt_dev. timeout = 5000/1000 = 5` (秒)
2. 在 `hal_watchdog_set_top ()` 中，遍历 top 值 (0-15)：
   - 当 top=0 时：(1 << 16) / 24000000 ≈ 0.0027 秒 (小于 5 秒)
   - 当 top=1 时：(1 << 17) / 24000000 ≈ 0.0055 秒 (小于 5 秒)
   - ...
   - 当 top=10 时：(1 << 26) / 24000000 ≈ 2.8 秒 (小于 5 秒)
   - 当 top=11 时：(1 << 27) / 24000000 ≈ 5.6 秒 (大于 5 秒)
1. 因此选择 top=11，实际超时时间为约 5.6 秒

#### 重要特性

1. **硬件限制**：
   - 看门狗只支持 16 个离散的超时值（0-15）
   - 实际超时时间是 2 的幂次方关系，不能精确设置任意值

2. **向上取整**：
   - 驱动总是选择大于等于用户设置时间的值
   - 这确保系统至少有用户要求的超时时间，不会提前触发

3. **时钟依赖**：
   - 超时时间与系统时钟频率成反比
   - 在本实现中使用固定的 24MHz 时钟

4. **最大超时时间**：
   - 当 top=15 时，超时时间为 (1 << 31) / 24000000 ≈ 89.5 秒
   - 这是该硬件实现支持的最大超时时间

总结来说，看门狗的计时时间是通过选择一个预设的 2 的幂次方周期数，然后除以系统时钟频率来计算的。由于硬件限制，实际超时时间只能是一组离散值，驱动会自动选择大于等于用户设置时间的最小可用值。

---

## WDT_CCVR
- **Name**: WDT Current Counter Value Register
- **Description**: 当前计数器值寄存器
- **Size**: 32 bits
- **Offset**: 0x8
- **Exists**: Always


| 位域    | 名称            | 访问  | 描述                                                                |
|--------|----------------|-------|-------------------------------------------------------------------|
| 31: y   | RSVD_WDT_CCVR  | R     | 保留位，读取为 0（y = WDT_CNT_WIDTH）                                 |
| x: 0    | WDT_CCVR       | R     | 当前计数器值（x = WDT_CNT_WIDTH - 1）。<br>默认值: WDT_CNT_WIDTH - 1。 |

**注意**:
- 复位值：由配置参数决定。
- 属性：只读，易变（Volatile）。

---

## WDT_CRR
- **Name**: WDT Counter Restart Register
- **Description**: 计数器重启寄存器
- **Size**: 32 bits
- **Offset**: 0xc
- **Exists**: Always


| 位域   | 名称           | 访问  | 描述                                                                                                 |
| ---- | ------------ | --- | -------------------------------------------------------------------------------------------------- |
| 31:8 | RSVD_WDT_CRR | W   | 保留位，仅写                                                                                             |
| 7:0  | WDT_CRR      | W   | 计数器重启寄存器。<br>此寄存器用于重新启动 WDT 计数器。作为防止意外重启的安全功能，必须写入值 0x76。<br>重启会清除 WDT 中断。<br>读取返回 0。<br>默认值: 0x0。 |

**注意**:
- 手册描述产生中断后会自动重新开始计数，不需要写入 0x76；但我们驱动中是在执行完上层的回调之后会重新写入 0x76，以手动重启计数

---

## WDT_STAT
- **Name**: WDT Interrupt Status Register
- **Description**: 中断状态寄存器
- **Size**: 32 bits
- **Offset**: 0x10
- **Exists**: Always


| 位域    | 名称            | 访问  | 描述                                                                |
|--------|----------------|-------|-------------------------------------------------------------------|
| 31:1   | RSVD_WDT_STAT  | R     | 保留位，读取为 0                                                      |
| 0      | WDT_STAT       | R     | 中断状态。<br>0: 中断未激活。<br>1: 中断激活。<br>默认值: 0x0。         |

**注意**:
- 复位值：0x0。
- 属性：只读，易变（Volatile）。

---

## WDT_EOI
- **Name**: WDT End of Interrupt Register
- **Description**: 中断清除寄存器
- **Size**: 32 bits
- **Offset**: 0x14
- **Exists**: Always


| 位域    | 名称            | 访问  | 描述                                                                |
|--------|----------------|-------|-------------------------------------------------------------------|
| 31:1   | RSVD_WDT_EOI   | R     | 保留位，读取为 0                                                      |
| 0      | WDT_EOI        | R     | 中断清除。<br>读取此寄存器以清除中断。<br>默认值: 0x0。                 |

**注意**:
- 复位值：0x0。
- 属性：只读，易变（Volatile）。

---

## WDT_PROT_LEVEL
- **Name**: WDT Protection Level Register
- **Description**: 保护级别寄存器
- **Size**: 32 bits
- **Offset**: 0x1c
- **Exists**: 当 SLAVE_INTERFACE_TYPE > 1（即 APB4）时


| 位域   | 名称             | 访问      | 描述                 |
| ---- | -------------- | ------- | ------------------ |
| 31:2 | RSVD_WDT_PROT  | R       | 保留位，读取为 0          |
| 1:0  | WDT_PROT_LEVEL | *Varies | 保护级别。<br>反映当前保护级别。 |

**注意**:
- 复位值：由配置参数决定。
- 属性：只读。

---

## WDT_COMP_PARAM_5
- **Name**: WDT Component Parameter Register 5
- **Description**: 组件参数寄存器 5
- **Size**: 32 bits
- **Offset**: 0xe4
- **Exists**: Always


| 位域   | 名称               | 访问  | 描述                     |
| ---- | ---------------- | --- | ---------------------- |
| 31:0 | WDT_COMP_PARAM_5 | R   | 超时周期的上限。<br>具体内容见数据手册。 |

**注意**:
- 复位值：由配置参数决定。
- 属性：只读。

---

## WDT_COMP_PARAM_4
- **Name**: WDT Component Parameter Register 4
- **Description**: 组件参数寄存器 4
- **Size**: 32 bits
- **Offset**: 0xe8
- **Exists**: Always


| 位域   | 名称               | 访问  | 描述                         |
| ---- | ---------------- | --- | -------------------------- |
| 31:0 | WDT_COMP_PARAM_4 | R   | 初始超时周期参数的上限。<br>具体内容见数据手册。 |

**注意**:
- 复位值：由配置参数决定。
- 属性：只读。

---

## WDT_COMP_PARAM_3
- **Name**: WDT Component Parameter Register 3
- **Description**: 组件参数寄存器 3
- **Size**: 32 bits
- **Offset**: 0xec
- **Exists**: Always


| 位域    | 名称            | 访问  | 描述                                                                |
|--------|----------------|-------|-------------------------------------------------------------------|
| 31:0   | WDT_COMP_PARAM_3 | R   | 组件参数 3。<br>具体内容见数据手册。                                    |

**注意**:
- 复位值：由配置参数决定。
- 属性：只读。

---

## WDT_COMP_PARAM_2
- **Name**: WDT Component Parameter Register 2
- **Description**: 组件参数寄存器 2
- **Size**: 32 bits
- **Offset**: 0xf0
- **Exists**: Always


| 位域    | 名称            | 访问  | 描述                                                                |
|--------|----------------|-------|-------------------------------------------------------------------|
| 31:0   | WDT_COMP_PARAM_2 | R   | 组件参数 2。<br>具体内容见数据手册。                                    |

**注意**:
- 复位值：由配置参数决定。
- 属性：只读。

---

## WDT_COMP_PARAM_1
- **Name**: WDT Component Parameter Register 1
- **Description**: 组件参数寄存器 1
- **Size**: 32 bits
- **Offset**: 0xf4
- **Exists**: Always


| 位域    | 名称            | 访问  | 描述                                                                |
|--------|----------------|-------|-------------------------------------------------------------------|
| 31:0   | WDT_COMP_PARAM_1 | R   | 组件参数 1。<br>具体内容见数据手册。                                    |

**注意**:
- 复位值：由配置参数决定。
- 属性：只读。

---

## WDT_COMP_VERSION
- **Name**: WDT Component Version Register
- **Description**: 组件版本寄存器
- **Size**: 32 bits
- **Offset**: 0xf8
- **Exists**: Always


| 位域    | 名称            | 访问  | 描述                                                                |
|--------|----------------|-------|-------------------------------------------------------------------|
| 31:0   | WDT_COMP_VERSION | R   | 组件版本。<br>具体内容见数据手册。                                      |

**注意**:
- 复位值：由配置参数决定。
- 属性：只读。

---

## WDT_COMP_TYPE
- **Name**: WDT Component Type Register
- **Description**: 组件类型寄存器
- **Size**: 32 bits
- **Offset**: 0xfc
- **Exists**: Always


| 位域    | 名称            | 访问  | 描述                                                                |
|--------|----------------|-------|-------------------------------------------------------------------|
| 31:0   | WDT_COMP_TYPE  | R     | 组件类型。<br>具体内容见数据手册。                                      |

**注意**:
- 复位值：由配置参数决定。
- 属性：只读。




# 编程手册

以下是基于 *DesignWare DW_apb_wdt Databook*（版本 1.11a，2018 年 7 月）中提供的信息，关于如何编程 DesignWare DW_apb_wdt（高级外设总线看门狗定时器）的详细流程。DW_apb_wdt 是一个可编程的看门狗定时器外设，用于防止系统由于软件或硬件冲突而锁死。本流程以文档中第 6 章“Programming the DW_apb_wdt”为基础，并结合相关功能描述和参数配置，提供一个完整的编程步骤指南。

---

#### **编程概述**
DW_apb_wdt 是一个小端格式的 APB 从设备，其寄存器最大宽度为 32 位，所有寄存器都按 32 位边界对齐。编程通过 APB 接口访问其内部寄存器完成。以下是编程时的关键考虑因素：
- **复位**：APB 总线复位信号（`presetn`）会将所有寄存器恢复到默认状态。
- **基地址**：DW_apb_wdt 的基地址由系统中的 DW_apb 模块生成 `psel` 信号时确定，寄存器使用相对于基地址的偏移量寻址。
- **一致性**：当数据总线宽度小于计数器宽度时（如 `WDT_CCVR` 寄存器），读取操作需要一致性逻辑支持。

以下流程以文档中的示例配置为基础，假设：
- 使用单一超时周期（`WDT_DUAL_TOP = 0`）。
- 输出响应模式未硬编码（`WDT_HC_RMOD = 0`）。
- 复位脉冲长度未硬编码（`WDT_HC_RPL = 0`）。
- 看门狗并非始终使能（`WDT_ALWAYS_EN = 0`）。
- 配置为先产生中断，后产生系统复位（`WDT_DFLT_RMOD = 1`）。

---

#### **编程步骤**

1. **初始化配置**
   - **目的**：在启用看门狗之前，设置其工作参数。
   - **步骤**：
     - **设置超时周期（WDT_TORR 寄存器，偏移 0x4）**：
       - 写入 `TOP` 字段（位 [3:0]）以选择超时周期。例如，若 `WDT_USE_FIX_TOP = 1`，值为 0 表示 64K 时钟周期，1 表示 128K 时钟周期，依此类推（见第 57 页，表 5-7）。
       - 如果未硬编码（`WDT_HC_TOP = 0`），此值可编程；否则使用默认值 `WDT_DFLT_TOP`。
     - **设置复位脉冲长度（WDT_CR 寄存器，偏移 0x0）**：
       - 写入 `RPL` 字段（位 [4:2]）以定义系统复位信号的持续时间。例如，0x0 表示 2 个 `pclk` 周期，0x7 表示 256 个周期（见第 52 页，表 5-6）。
       - 如果未硬编码（`WDT_HC_RPL = 0`），此值可编程。
     - **设置响应模式（WDT_CR 寄存器，偏移 0x0）**：
       - 写入 `RMOD` 位（位 1）以选择超时时的响应模式。值为 1 表示“先产生中断，若第二次超时则产生复位”；值为 0 表示“直接产生复位”（见第 52 页，表 5-6）。
       - 示例配置中，设为 1。
   - **注意**：这些配置应在启用看门狗之前完成，尤其是 `WDT_TORR`，因为其更改仅在下一次计数器重启（“踢狗”）后生效。

2. **启用看门狗**
   - **目的**：启动看门狗计数器，开始监控系统。
   - **步骤**：
     - 写入 `WDT_CR` 寄存器的 `WDT_EN` 位（位 0）为 1（见第 53 页，表 5-6）。
     - 如果 `WDT_ALWAYS_EN = 1`，看门狗在复位后自动启用，此步骤无效；示例中为 0，故需手动启用。
     - **安全特性**：一旦启用，`WDT_EN` 只能通过系统复位清零，防止软件错误禁用看门狗。
   - **结果**：计数器从预设超时值（由 `WDT_TORR.TOP` 定义）开始递减至 0。

3. **监控和维护（“踢狗”）**
   - **目的**：定期重启计数器，防止超时。
   - **步骤**：
     - 写入 `WDT_CRR` 寄存器（偏移 0xc）的值为 0x76，以重启计数器（见第 60 页，表 5-9）。
     - **安全特性**：必须写入特定值 0x76，防止意外重启。
     - 重启会将计数器恢复到 `WDT_TORR.TOP` 定义的超时值，并继续递减。
     - 若配置了中断模式（`RMOD = 1`），重启还会清除当前中断。
   - **频率**：需在计数器达到 0 之前执行“踢狗”，频率取决于超时周期设置。

4. **处理中断（若启用）**
   - **目的**：在超时产生中断时响应并清除。
   - **步骤**：
     - 检查 `WDT_STAT` 寄存器（偏移 0x10）的位 0，若为 1 表示中断激活（见第 61 页，表 5-10）。
     - 清除中断：
       - 读取 `WDT_EOI` 寄存器（偏移 0x14），位 0 会返回当前中断状态并清除中断（见第 62 页，表 5-11）；或
       - 执行“踢狗”（写入 `WDT_CRR` = 0x76），同时清除中断并重启计数器。
     - 如果在第二次超时前未清除中断（且 `WDT_NEW_RMOD = 0`），或无论是否清除（`WDT_NEW_RMOD = 1`），将触发系统复位（见第 23-24 页，图 2-7 至 2-9）。
   - **示例配置**：`RMOD = 1`，需在下一次超时前处理中断。

5. **处理系统复位（若发生）**
   - **目的**：识别并响应看门狗触发的系统复位。
   - **条件**：
     - 若 `RMOD = 0`，计数器到 0 时直接产生复位。
     - 若 `RMOD = 1` 且第二次超时发生，则产生复位。
   - **步骤**：
     - 系统复位信号（`wdt_sys_rst` 或 `wdt_sys_rst_n`，取决于 `WDT_RST_POL`）会激活，持续时间由 `WDT_CR.RPL` 定义（见第 22 页，图 2-5）。
     - 外部复位控制器处理此信号，可能重启整个系统。
   - **注意**：若复位后需重新配置看门狗，从步骤 1 开始。

---

#### **示例流程图**
以下是文档中提供的示例操作流程（见第 76 页，图 6-1）的文字描述：
1. **复位状态**：所有寄存器复位，`WDT_EN = 0`，计数器未运行。
2. **设置参数**：配置 `WDT_TORR.TOP` 和 `WDT_CR.RPL`，设置 `WDT_CR.RMOD = 1`。
3. **启用看门狗**：写入 `WDT_CR.WDT_EN = 1`，计数器开始递减。
4. **正常运行**：
   - 若在超时前写入 `WDT_CRR = 0x76`，计数器重启，循环继续。
   - 若超时：
     - 第一次：产生中断，检查 `WDT_STAT`，清除中断（`WDT_EOI` 或 `WDT_CRR`）。
     - 第二次（若未及时“踢狗”）：产生系统复位。
5. **复位后**：返回初始状态，重新配置。

---

#### **注意事项**
- **时钟配置**：若启用异步时钟（`WDT_ASYNC_CLK_MODE_ENABLE = 1`），中断和复位信号可能在 `tclk` 和 `pclk` 域间异步（见第 20-23 页，图 2-2 至 2-6）。
- **一致性读取**：读取 `WDT_CCVR`（偏移 0x8）以查看当前计数值时，若 `APB_DATA_WIDTH < WDT_CNT_WIDTH`，需多次读取并确保一致性（见第 59 页，表 5-8）。
- **参数检查**：具体值（如超时周期范围）取决于配置参数，参考第 3 章“Parameter Descriptions”（第 29-36 页）。



# 测试用例

- 复位 
	- reboot
- 喂狗
	- 没有测试代码
	- 在中断里面喂狗或者手动敲命令喂狗
	- 定时一个 10s，然后 10s 内手动喂狗，不喂狗就复位了
	- 中断持续喂狗
- 使能中断
	- 没有测试代码
- 读取定时器值
	- 没有测试代码
	- 启动看门狗
	- 查寄存器：`WDT_CCVR 0x8`
	- hal 接口中都没有这个代码，需要自己加



# 测试 case
- reboot



# 代码熟悉
-  [[dw_wdt.xmind]]