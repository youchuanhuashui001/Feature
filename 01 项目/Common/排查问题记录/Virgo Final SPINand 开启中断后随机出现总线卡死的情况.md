
> 背景：测试 `Virgo Flash SPI` 模块时，`SPINand`  开启中断后从 `flash` 启动会卡死

- 关掉 `cache` 之后仍然有这个问题
- 用 `gdb` 加载不会有这问题
- 使用 `O0` 编译也不会有这问题
- 没开 `dma` 

## 芯片拉线
- 发现访问了 `0xf1540240` 这个地址，这个地址是 `Demux` 模块的地址，但是只是在跑 `flash` 的测试程序，不会去访问 `0xf1540240` 这个地址的


## 软件排除
- 在 `MMU` 中不配置 `0xf1500000` 这个地址的映射，也就是说如果访问了 `0xf1500000` 的话就会出现 `data_abort` 异常
	- 发现不出了，并且也无法用 `awatch、rwatch *0xf1540240` 捕捉到
- 将 `0xf1500000` 对应的地址映射回来，就会出了
	- 将 `0xf1500000` 这个虚拟地址映射到 `0x100000` 这个物理地址 (本来是 `Kernel` 用的，所以是空的一片内存)
	- 芯片拉线看到有访问 `0x1400240` 这个地址，但是还是用 `rwatch` 捕获不到
		- **这个时候如果 `rwatch` 看不到的话，说明不是程序的主动行为**
	- 反汇编 `start.S` 看到在 `fiq` 函数的后面刚好是看门狗的基地址 `0xfa450000`，并且这个被当成了立即数，被译码成了 `blx 0xf1540248` 这条语句
		- `cpu` 会随机预取 `N` 条指令，这个 `blx 0xf1540248` 这条指令刚好在下一条 `cache line` 上，所以有机会被随机预取到
		- 当预取到这条指令，`cpu` 认为是一个跳转指令，所以也会预取跳转的地址 `0xf1540248`，这个时候就会出现访问 `0xf1540240` 的情况，导致总线挂了 
![[2024-12-06_14-40.png]]



![[2024-12-06_15-44.png]]



## 问题原因
- 查到是由于 `cpu`  在执行 `irq`  的时候预取了一条 `blx 0xf1540248`  指令，使得 `cpu`  访问了 `0xf150240`  这个地址，但是 `0xf1540240`  这个地址对应的模块没有被芯片编进去，访问会让总线卡死
- 之所以会预取到一条 `blx 0xf1540248 ` 这条指令是由于 ` watchdog ` 的基址是 ` 0xfa450000 ` ，这个地址被当成了一个立即数，程序优化后放到了 ` fiq `  函数的下一条指令，而 ` 0xfa450000 `  被译码成了 ` blx 0xf1540248 ` 

